groups:
- name: ab-quality
  interval: 30s
  rules:
  # (2) 분산·고유값을 지표로 상시 노출 (Prometheus 레코딩룰)
  - record: ab_eval_unique_p_2h
    expr: count(sum by (ev) (duri_ab_p_value) > bool -1)  # 라벨p 존재 ev 개수
  
  - record: ab_eval_sigma_2h
    expr: stddev_over_time(duri_ab_p_value[2h])
  
  # H1: 효과적 EV 메트릭 (2h 창에서 n≥1 EV 개수)
  - record: ab_effective_ev_2h
    expr: sum_over_time(duri_ab_effective_ev[2h])
  
  # 하드닝 #5: 효과적 EV 정의를 규칙으로 명문화 (SYN 제외)
  - record: ab:effective_ev_2h
    expr: count_over_time(duri_ab_p_value{ev!~".*-SYN.*"}[2h])
  
  # 3h 진단 보조 지표
  - record: ab_eval_unique_p_3h
    expr: count(sum by (ev) (duri_ab_p_value) > bool -1)
  
  - record: ab_eval_sigma_3h
    expr: stddev_over_time(duri_ab_p_value[3h])
  
  # (2) 알람: AB 분산 붕괴 (하드닝: SYN 제외 강제)
  - alert: ABVarianceCollapsed
    expr: stddev_over_time(duri_ab_p_value{ev!~".*-SYN.*"}[2h]) == 0
    for: 10m
    labels: {severity: warning}
    annotations:
      summary: "AB 분산 붕괴 (SYN 제외)"
      description: "sigma == 0 (최근 2h, SYN 제외). Check Γ2 (EV별 입력/시드 분기)."
  
  # H2: 효과적 EV 부족 알람 (하드닝 #5: 명확화)
  - alert: ABEffectiveEVLow
    expr: ab:effective_ev_2h < 2
    for: 10m
    labels: {severity: warning}
    annotations:
      summary: "Effective EV below target (<2 in 2h)"
      description: "Only {{ $value }} effective EV(s) with n>=1 samples in last 2h (SYN excluded). Check sample collection."
  
  # Δ2: NaN/0 샘플 경보 (2h 창)
  - alert: ABPSigmaNoSamples2H
    expr: |
      (
        duri_p_samples{window="2h"} == 0
      ) or
      (
        duri_p_sigma{window="2h"} != duri_p_sigma{window="2h"}
      )
    for: 30m
    labels:
      severity: warning
      cause: no-samples-or-nan
      subsystem: ab-p-sigma
    annotations:
      summary: "p-sigma 2h window: no samples or NaN for > 30m"
      description: "Window 2h: samples={{ $value }} or sigma=NaN. Check p_sigma_export.py execution and p_values_2h.prom generation."
  
  # Δ2: NaN/0 샘플 경보 (24h 창)
  - alert: ABPSigmaNoSamples24H
    expr: |
      (
        duri_p_samples{window="24h"} == 0
      ) or
      (
        duri_p_sigma{window="24h"} != duri_p_sigma{window="24h"}
      )
    for: 30m
    labels:
      severity: warning
      cause: no-samples-or-nan
      subsystem: ab-p-sigma
    annotations:
      summary: "p-sigma 24h window: no samples or NaN for > 30m"
      description: "Window 24h: samples={{ $value }} or sigma=NaN. Check p_sigma_export.py execution and p_values_24h.prom generation."
  
  # KS-Uniform 품질검정 알람
  - alert: ABPValuesKSUniformityLost
    expr: duri_p_uniform_ks_p{window="24h"} < 0.05
    for: 2h
    labels:
      severity: warning
      subsystem: ab-p-quality
    annotations:
      summary: "p-value 분포가 Uniform에서 이탈(24h)"
      description: "KS-test p-value = {{ $value }} < 0.05. p-value 분포가 균등분포에서 이탈. 실험 자체 변동 부족 가능성."
  
  # 변이 존재(샘플·중복) 게이트
  - alert: ABPValuesUniformityLost
    expr: |
      (duri_p_samples{window="2h"} < 12) or
      (duri_p_samples{window="24h"} < 12) or
      (duri_p_unique_ratio{window="2h"} < 0.2) or
      (duri_p_unique_ratio{window="24h"} < 0.2)
    for: 60m
    labels: { severity: warning }
    annotations:
      summary: "AB p-values 변이 부족"
      description: "samples(2h/24h) 또는 unique_ratio<0.2"
  
  # KS-Uniform 이상(편향 의심) 게이트
  - alert: ABPValuesKSDrift
    expr: |
      (duri_p_uniform_ks_p{window="2h"} < 0.2) or
      (duri_p_uniform_ks_p{window="24h"} < 0.2)
    for: 60m
    labels: { severity: warning }
    annotations:
      summary: "AB p-values KS drift"
      description: "KS p<0.2 (U(0,1) 위반 가능)"

