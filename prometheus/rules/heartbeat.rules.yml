groups:
- name: heartbeat
  interval: 30s
  rules:
  # Recording rule: Heartbeat age (seconds since last update)
  # Used as intermediate value for freshness checks
  - record: duri_heartbeat_age_seconds
    labels:
      metric_realm: "prod"
    expr: time() - duri_textfile_heartbeat_ts{metric_realm="prod"}
  
  # Recording rule: Heartbeat OK (1 = healthy within 120s, 0 = stale)
  # Label-preserving 0 fallback: 0 * duri_textfile_heartbeat_ts preserves labels
  - record: duri_heartbeat_ok
    labels:
      metric_realm: "prod"
    expr: (duri_heartbeat_age_seconds{metric_realm="prod"} < 120)
          OR on(metric_realm,job,instance) 0 * duri_textfile_heartbeat_ts{metric_realm="prod"}
  
  # Recording rule: Heartbeat stall detection (1 = stale >= 120s, 0 = fresh)
  # Label-preserving 0 fallback
  - record: duri_heartbeat_stall
    labels:
      metric_realm: "prod"
    expr: (duri_heartbeat_age_seconds{metric_realm="prod"} >= 120)
          OR on(metric_realm,job,instance) 0 * duri_textfile_heartbeat_ts{metric_realm="prod"}
  
  # Recording rule: Heartbeat changes (number of changes in 6m window)
  # increase() works with gauge metrics
  # Label-preserving 0 fallback
  - record: duri_heartbeat_changes_6m
    labels:
      metric_realm: "prod"
    expr: increase(duri_textfile_heartbeat_seq{metric_realm="prod"}[6m])
          OR on(metric_realm,job,instance) 0 * duri_textfile_heartbeat_ts{metric_realm="prod"}
  
  # Recording rule: Heartbeat fresh_120s (backward compatibility)
  # Same as duri_heartbeat_ok for consistency
  - record: duri_heartbeat_fresh_120s
    labels:
      metric_realm: "prod"
    expr: (duri_heartbeat_age_seconds{metric_realm="prod"} < 120)
          OR on(metric_realm,job,instance) 0 * duri_textfile_heartbeat_ts{metric_realm="prod"}
