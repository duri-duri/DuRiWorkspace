groups:
- name: heartbeat
  interval: 30s
  rules:
  # Recording rule: Heartbeat changes (number of changes in 6m window)
  # Window: 6m = HB(60s) + 2*SI(30s) + Îµ for safety margin
  # changes() works with gauge metrics and counts value changes
  # Filter by metric_realm="prod" to avoid legacy series
  # This is the raw count of changes (for debugging/monitoring)
  - record: duri_heartbeat_changes_6m
    labels:
      metric_realm: "prod"
    expr: clamp_max(changes(duri_textfile_heartbeat_seq{metric_realm="prod"}[6m]), 1e9) or on() vector(0)
  
  # Recording rule: Heartbeat freshness (recent sample within 120s)
  # Direct timestamp check: time() - duri_textfile_heartbeat_ts <= 120
  # Missing values coalesced to 0 (operational safety)
  - record: duri_heartbeat_fresh_120s
    labels:
      metric_realm: "prod"
    expr: ((time() - duri_textfile_heartbeat_ts{metric_realm="prod"}) <= 120) or on() vector(0)
  
  # Recording rule: Heartbeat OK (1 = healthy, 0 = stalled)
  # OK if: changes > 0 AND fresh_120s == 1 (both conditions must be met)
  - record: duri_heartbeat_ok
    labels:
      metric_realm: "prod"
    expr: ((duri_heartbeat_changes_6m > 0) and (duri_heartbeat_fresh_120s == 1)) or on() vector(0)
  
  # Recording rule: Heartbeat stall detection (for alerts)
  # Stall if: ok == 0 (inverse of OK)
  - record: duri_heartbeat_stall
    labels:
      metric_realm: "prod"
    expr: (1 - duri_heartbeat_ok) or on() vector(0)
