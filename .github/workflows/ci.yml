name: DuRi Core CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          persist-credentials: true

      - name: Auth for legacy submodules (HTTPS)
        run: |
          git config --global http.https://github.com/.extraheader \
            "AUTHORIZATION: basic $(printf "x-access-token:%s" "$GITHUB_TOKEN" | base64 -w0)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Init legacy submodules only
        run: |
          git submodule set-url duri_core_legacy      https://github.com/duri-duri/duri_core.git
          git submodule set-url duri_brain_legacy     https://github.com/duri-duri/duri_brain.git
          git submodule set-url duri_evolution_legacy https://github.com/duri-duri/duri_evolution.git
          git submodule set-url duri_control_legacy   https://github.com/duri-duri/duri_control.git
          git submodule update --init --recursive --checkout duri_*_legacy

      - name: Detect relevant changes
        id: detect
        run: |
          set -euo pipefail
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}
          CHANGED=$(git diff --name-only "$BASE" "$HEAD" -- \
            'DuRiCore/**' 'src/**' 'tests/**' 'docker/**' 'scripts/**' 'requirements*.txt' | xargs -r)
          if [ -z "$CHANGED" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            echo "üü° No relevant code changes, skipping tests."
          else
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "üß© Changed files: $CHANGED"
          fi

      - name: Set up Python
        if: steps.detect.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: steps.detect.outputs.run == 'true'
        run: |
          python -m pip install -U pip
          pip install pytest pytest-cov
          [ -f requirements.txt ] && pip install -r requirements.txt || true

      - name: Run tests
        if: steps.detect.outputs.run == 'true'
        run: pytest -v || echo "‚ö†Ô∏è Tests failed, please review."

      - name: Skip tests (workflow-only PR)
        if: steps.detect.outputs.run != 'true'
        run: echo "‚úÖ Skipped tests since only workflow files changed."
