name: freeze-guard
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, labeled, unlabeled]
permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  enforce-freeze:
    if: ${{ github.base_ref == 'main' && !contains(join(fromJson(toJson(github.event.pull_request.labels || fromJSON('[]'))).*.name, ','), 'freeze:override') && !contains(join(fromJson(toJson(github.event.pull_request.labels || fromJSON('[]'))).*.name, ','), 'override-freeze') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: dorny/paths-filter@v3
        id: paths
        with:
          filters: |
            ci_only:
              - '.github/workflows/**'
              - 'tests/**'
              - 'Makefile'
              - 'docs/**'
              - 'scripts/ci/**'
              - 'scripts/ops/**'
              - 'prometheus/**'
              - 'compose.observation.ci.yml'
      - name: Skip freeze for CI-only changes
        if: ${{ steps.paths.outputs.ci_only == 'true' }}
        run: |
          echo "CI-only change detected â†’ freeze bypass"
          echo "Changed files: ${{ steps.paths.outputs.ci_only_files }}"
          exit 0
      - name: Install jq
        if: ${{ steps.paths.outputs.ci_only != 'true' }}
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Check last commit trailer (Override-Freeze)
        if: ${{ steps.paths.outputs.ci_only != 'true' }}
        run: |
          # ê¸°ë³¸: Freeze ON â†’ í•­ìƒ ë§‰ìŒ
          FREEZE_ON=1

          # PR ë¼ë²¨ë¡œ 'ê¸´ê¸‰' í—ˆìš© í† ê¸€ (ì›í•˜ë©´ ì œê±° ê°€ëŠ¥)
          if echo '${{ toJson(github.event.pull_request.labels) }}' \
            | jq -e '.[]|select(.name=="override-freeze" or .name=="freeze:override")' >/dev/null; then
            FREEZE_ON=0
          fi

          if [ "$FREEZE_ON" = "1" ]; then
            echo "ğŸ›‘ Freeze ON: PRì€ ê¸°ë³¸ì ìœ¼ë¡œ ì°¨ë‹¨ë©ë‹ˆë‹¤."
            echo "    - ê¸´ê¸‰ ì‹œ: ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ì— 'Override-Freeze: true' íŠ¸ë ˆì¼ëŸ¬ í•„ìš”"
            echo "    - (í•„ìš” ì‹œ) ì„œëª… ì»¤ë°‹"
          fi

          LAST_MSG="$(git log -1 --pretty=%B)"
          HAS_TRAILER=$(printf "%s" "$LAST_MSG" | grep -cE '^Override-Freeze:\s*true$' || true)

          if [ "$FREEZE_ON" = "1" ] && [ "$HAS_TRAILER" -eq 0 ]; then
            echo "Missing required trailer: Override-Freeze: true"
            exit 1
          fi

      - name: (ì„ íƒ) GPG ì„œëª… ê²€ì¦
        if: ${{ always() }}
        run: |
          # í•„ìš” ì‹œ í•„ìˆ˜í™”: ì‹¤íŒ¨í•˜ë©´ exit 1
          if git verify-commit -v HEAD; then
            echo "GPG signature OK"
          else
            echo "WARN: commit not signed or unverifiable"
            # exit 1  # <- ì„œëª… í•„ìˆ˜ë¡œ ë°”ê¿€ ë•Œ ì£¼ì„ í•´ì œ
          fi
