name: freeze-guard
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, labeled, unlabeled]
permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  enforce-freeze:
    runs-on: ubuntu-latest
    if: ${{ github.base_ref == 'main' }} # main 병합 대상만 검사
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Check last commit trailer (Override-Freeze)
        run: |
          # 기본: Freeze ON → 항상 막음
          FREEZE_ON=1

          # PR 라벨로 '긴급' 허용 토글 (원하면 제거 가능)
          if echo '${{ toJson(github.event.pull_request.labels) }}' \
            | jq -e '.[]|select(.name=="override-freeze")' >/dev/null; then
            FREEZE_ON=0
          fi

          if [ "$FREEZE_ON" = "1" ]; then
            echo "🛑 Freeze ON: PR은 기본적으로 차단됩니다."
            echo "    - 긴급 시: 마지막 커밋 메시지에 'Override-Freeze: true' 트레일러 필요"
            echo "    - (필요 시) 서명 커밋"
          fi

          LAST_MSG="$(git log -1 --pretty=%B)"
          HAS_TRAILER=$(printf "%s" "$LAST_MSG" | grep -cE '^Override-Freeze:\s*true$' || true)

          if [ "$FREEZE_ON" = "1" ] && [ "$HAS_TRAILER" -eq 0 ]; then
            echo "Missing required trailer: Override-Freeze: true"
            exit 1
          fi

      - name: (선택) GPG 서명 검증
        if: ${{ always() }}
        run: |
          # 필요 시 필수화: 실패하면 exit 1
          if git verify-commit -v HEAD; then
            echo "GPG signature OK"
          else
            echo "WARN: commit not signed or unverifiable"
            # exit 1  # <- 서명 필수로 바꿀 때 주석 해제
          fi
