name: proof-gates
on: [pull_request]
jobs:
  gates:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: G1 - Booting Smoke Test
        run: bash tools/smoke.sh 150
      - name: G2 - Log ABI Check
        run: bash tools/log_abi_check.sh
      - name: G3 - Metrics ABI Guard
        run: bash tools/metrics_guard.sh
      - name: G4 - Settings Priority Gate
        run: bash tools/settings_gate.sh
  day38-m3-suggest:
    if: contains(github.event.pull_request.labels.*.name, 'auto-fix:suggest')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }
      - run: pip install -r requirements.txt || true

      - name: Download failed job artifacts
        uses: actions/download-artifact@v4
        if: failure()
        with:
          path: ./artifacts
          pattern: "*"
          merge-multiple: true
        continue-on-error: true

      - name: Run suggester on artifacts
        run: |
          # Try to find log files in artifacts
          find ./artifacts -name "*.log" -o -name "*.txt" | head -5 | while read logfile; do
            echo "Processing: $logfile"
            cat "$logfile" | python3 tools/auto_fix_suggester.py > suggest.json
            if [ -s suggest.json ]; then
              echo "Found suggestions in $logfile"
              break
            fi
          done

          # Fallback to demo if no artifacts
          if [ ! -s suggest.json ]; then
            echo "E   ModuleNotFoundError: No module named 'foo_bar'" | python3 tools/auto_fix_suggester.py > suggest.json
          fi
          cat suggest.json

      - name: Comment suggestions
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -s suggest.json ]; then
            confidence=$(jq -r '.avg_confidence // 0' suggest.json)
            total_matches=$(jq -r '.total_matches // 0' suggest.json)
            body="üõ†Ô∏è **Auto Fix Suggestions (M4 Enhanced)**\n\n"
            body+="üìä **Confidence**: ${confidence:.2f} | **Matches**: ${total_matches}\n\n"
            body+="\`\`\`json\n$(cat suggest.json)\n\`\`\`"
            gh pr comment ${{ github.event.pull_request.number }} --body "$body"
          else
            echo "No suggestions found"
          fi
