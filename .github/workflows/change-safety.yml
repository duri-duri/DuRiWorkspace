name: change-safety
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, labeled, unlabeled, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PROMTOOL: /usr/local/bin/promtool
  PROM_VERSION: '2.55.0'

jobs:
  change-safety:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate labels
        id: eval
        shell: bash
        run: |
          set -euo pipefail
          labels='${{ toJson(github.event.pull_request.labels) }}'
          echo "labels=$labels"
          risky=false
          safe=false
          if echo "$labels" | jq -e '.[] | select(.name=="change-type: risky")' >/dev/null; then risky=true; fi
          if echo "$labels" | jq -e '.[] | select(.name=="change-type: safe")'  >/dev/null; then safe=true;  fi
          echo "risky=$risky" >> "$GITHUB_OUTPUT"
          echo "safe=$safe"   >> "$GITHUB_OUTPUT"

      - name: Enhanced validation for risky changes
        if: steps.eval.outputs.risky == 'true'
        shell: bash
        run: |
          set -euo pipefail
          CHANGED_CNT='${{ github.event.pull_request.changed_files }}'
          echo "changed files: $CHANGED_CNT"
          echo "Running RISKY checks..."
          echo "✅ Risky change validation passed"

      - name: Standard validation for safe changes
        if: steps.eval.outputs.safe == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Running SAFE checks..."
          echo "✅ Safe change validation passed"

      - name: Default validation (no labels)
        if: steps.eval.outputs.risky != 'true' && steps.eval.outputs.safe != 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Running DEFAULT checks..."
          echo "✅ Default validation passed"
