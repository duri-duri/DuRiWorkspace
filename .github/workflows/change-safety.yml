name: change-safety
on:
  pull_request:
    types: [opened, labeled, unlabeled]

jobs:
  risky-change-check:
    if: "${{ contains(github.event.pull_request.labels.*.name, 'change-type: risky') }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enhanced validation for risky changes
        run: |
          echo "RISKY CHANGE DETECTED - Running enhanced validation"
          make ci-all
          make grafana-lint
          make runbook-quality-guard
          echo "Enhanced validation passed"

  safe-change-check:
    if: "${{ contains(github.event.pull_request.labels.*.name, 'change-type: safe') }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Standard validation for safe changes
        run: |
          echo "SAFE CHANGE - Running standard validation"
          make prom-rules-ci
          make prom-dup-guard
          make alert-labels-guard
          echo "Standard validation passed"

  default-check:
    if: "${{ !contains(github.event.pull_request.labels.*.name, 'change-type: risky') && !contains(github.event.pull_request.labels.*.name, 'change-type: safe') }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Default validation (no labels)
        run: |
          echo "NO LABELS - Running standard validation"
          make prom-rules-ci
          make prom-dup-guard
          make alert-labels-guard
          echo "Default validation passed"
