name: required-checks-alias
on:
  workflow_run:
    workflows: ["repo-guards", "Phase-2 Suite", "freeze-guard"]
    types: [completed]

permissions:
  statuses: write
  contents: read
  actions: read

jobs:
  alias:
    runs-on: ubuntu-latest
    steps:
      - name: Post alias statuses when required checks are green
        env:
          REPO: ${{ github.repository }}
          SHA:  ${{ github.event.workflow_run.head_sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ok=$(gh api repos/$REPO/commits/$SHA/check-runs --jq \
            '[.check_runs[] | select(.name=="tests" or .name=="guards" or .name=="guard")] 
             | group_by(.name) 
             | map(max_by(.started_at).conclusion) 
             | all(.=="success")')
          if [[ "$ok" == "true" ]]; then
            for ctx in "phase-2 Suites / test" "repo-guard"; do
              gh api repos/$REPO/statuses/$SHA \
                -f state=success -f context="$ctx" -f description='auto alias'
            done
          else
            echo "Required checks not all green yet. Skipping."
          fi
