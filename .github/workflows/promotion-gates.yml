name: promotion-gates

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [ "main", "release/*" ]
  push:
    branches: [ "main", "release/*" ]

env:
  IS_DRY_RUN: ${{ contains(join(github.event.pull_request.labels.*.name, ','), 'dry-run') }}

jobs:
  dr-rehearsal-24h-pass:
    runs-on: ubuntu-latest
    steps:
      - name: Dry-run fast-pass
        if: env.IS_DRY_RUN == 'true'
        run: echo "dry-run: fast-pass" && exit 0
      
      - name: Real run
        if: env.IS_DRY_RUN != 'true'
        uses: actions/checkout@v4
      
      - name: assert DR histogram & p95 query
        if: env.IS_DRY_RUN != 'true'
        run: |
          set -eu
          # Check histogram format exists
          if ! grep -q 'duri_dr_rto_seconds_bucket' prometheus/rules/duri-observability-contract.rules.yml; then
            echo "[FAIL] DR histogram format not found in rules"
            exit 1
          fi
          
          # Check p95 recording rule exists
          if ! grep -q 'duri_dr_rto_seconds_p95_7d' prometheus/rules/duri-observability-contract.rules.yml; then
            echo "[FAIL] DR p95 recording rule not found"
            exit 1
          fi
          
          echo "[OK] DR histogram and p95 rules verified"

  canary-quorum-pass:
    runs-on: ubuntu-latest
    steps:
      - name: Dry-run fast-pass
        if: env.IS_DRY_RUN == 'true'
        run: echo "dry-run: fast-pass" && exit 0
      
      - name: Real run
        if: env.IS_DRY_RUN != 'true'
        uses: actions/checkout@v4
      
      - name: check quorum constants exist
        if: env.IS_DRY_RUN != 'true'
        run: |
          set -eu
          if ! grep -q 'min_samples:' .obs/promotion.yml; then
            echo "[FAIL] min_samples not found in promotion.yml"
            exit 1
          fi
          
          if ! grep -q 'ks_p_threshold:' .obs/promotion.yml; then
            echo "[FAIL] ks_p_threshold not found in promotion.yml"
            exit 1
          fi
          
          if ! grep -q 'unique_ratio_min:' .obs/promotion.yml; then
            echo "[FAIL] unique_ratio_min not found in promotion.yml"
            exit 1
          fi
          
          if ! grep -q 'dual_pass_required:' .obs/promotion.yml; then
            echo "[FAIL] dual_pass_required not found in promotion.yml"
            exit 1
          fi
          
          echo "[OK] Canary quorum constants verified"

  error-budget-burn-ok:
    runs-on: ubuntu-latest
    steps:
      - name: Dry-run fast-pass
        if: env.IS_DRY_RUN == 'true'
        run: echo "dry-run: fast-pass" && exit 0
      
      - name: Real run
        if: env.IS_DRY_RUN != 'true'
        uses: actions/checkout@v4
      
      - name: verify error budget rules
        if: env.IS_DRY_RUN != 'true'
        run: |
          set -eu
          if ! grep -q 'duri_error_budget_burn_short' prometheus/rules/error_budget.rules.yml; then
            echo "[FAIL] error_budget_burn_short rule not found"
            exit 1
          fi
          
          if ! grep -q 'duri_error_budget_burn_long' prometheus/rules/error_budget.rules.yml; then
            echo "[FAIL] error_budget_burn_long rule not found"
            exit 1
          fi
          
          if ! grep -q 'duri_error_budget_burn_ok' prometheus/rules/error_budget.rules.yml; then
            echo "[FAIL] error_budget_burn_ok rule not found"
            exit 1
          fi
          
          echo "[OK] Error budget rules verified"
