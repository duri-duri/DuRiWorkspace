name: insight-metrics-report

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'insight/**'
      - 'tests/test_metrics.py'
      - '.github/workflows/insight-metrics-report.yml'
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  metrics-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install -U pip pytest

      - name: Run metrics tests
        run: python -m pytest tests/test_metrics.py -v

      - name: Generate metrics report
        run: |
          python - <<'PY'
          import json
          from insight.metrics import evaluate_text
          sample_texts = [
              'The quick brown fox jumps over the lazy dog.',
              'A fast brown fox leaps over a sleepy canine.',
              'The dog is lazy and sleeps all day.',
              'Innovative solutions require creative thinking and comprehensive analysis.',
              'This is a very short text.',
          ]
          results = []
          for i, text in enumerate(sample_texts):
              r = evaluate_text(text, detailed=True)
              r['text'] = text
              r['index'] = i
              results.append(r)
          report = {
              'total_samples': len(sample_texts),
              'average_composite_score': sum(r['composite_score'] for r in results)/len(results),
              'results': results,
              'summary': {
                  'highest_score': max(results, key=lambda x: x['composite_score']),
                  'lowest_score': min(results, key=lambda x: x['composite_score']),
                  'score_range': max(r['composite_score'] for r in results) - min(r['composite_score'] for r in results),
              },
          }
          with open('metrics_report.json','w', encoding='utf-8') as f:
              json.dump(report, f, ensure_ascii=False, indent=2)
          print('Metrics report generated successfully!')
          PY

      - name: Upload metrics report
        uses: actions/upload-artifact@v4
        with:
          name: insight-metrics-report
          path: metrics_report.json
          retention-days: 30

      - name: Comment PR with metrics summary
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('metrics_report.json','utf8'));
            const esc = (s) => String(s).replace(/[`$\\]/g, (m) => ({'`':'\\`','$':'\\$','\\':'\\\\'}[m]));
            
            const lines = [];
            lines.push('## üìä Insight Metrics Report', '');
            lines.push('**Summary:**');
            lines.push(`- üìà Average Composite Score: ${report.average_composite_score.toFixed(3)}`);
            lines.push(`- üìä Score Range: ${report.summary.score_range.toFixed(3)}`);
            lines.push(`- üìù Total Samples: ${report.total_samples}`, '');
            lines.push('**Top Performer:**');
            lines.push(`> ${esc(report.summary.highest_score.text)}`);
            lines.push(`> Score: ${report.summary.highest_score.composite_score.toFixed(3)}`, '');
            lines.push('**Detailed Results:**');
            for (const [i, r] of report.results.entries()) {
              const txt = r.text.length > 50 ? r.text.slice(0, 50) + '...' : r.text;
              lines.push(`${i+1}. Score: ${r.composite_score.toFixed(3)} - ${esc(txt)}`);
            }
            lines.push('', 'üìÅ Full report available as artifact: `insight-metrics-report`');
            
            const body = lines.join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
