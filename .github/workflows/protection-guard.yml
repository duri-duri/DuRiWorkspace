name: protection-guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "17 * * * *"
  workflow_dispatch:

jobs:
  guard:
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check branch protection snapshot
        env:
          REPO: ${{ github.repository }}
          BRANCH: main
          SNAPSHOT: |
            {
              "required_status_checks": {
                "strict": true,
                "contexts": [
                  "obs-lint","sandbox-smoke-60s","promql-unit",
                  "dr-rehearsal-24h-pass","canary-quorum-pass","error-budget-burn-ok"
                ]
              },
              "require_code_owner_reviews": true,
              "required_approving_review_count": 1,
              "required_conversation_resolution": true,
              "enforce_admins": true,
              "required_linear_history": true
            }
        run: |
          curl -sSf -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/branches/$BRANCH/protection > /tmp/live.json
          node - <<'JS'
          const fs = require('fs');
          const want = JSON.parse(process.env.SNAPSHOT);
          const live = JSON.parse(fs.readFileSync('/tmp/live.json','utf8'));
          const get = (o,p)=>p.split('.').reduce((x,k)=>x?.[k],o);
          const checks = [
            ['required_status_checks.strict', true],
            ['required_pull_request_reviews.require_code_owner_reviews', want.require_code_owner_reviews],
            ['required_pull_request_reviews.required_approving_review_count', want.required_approving_review_count],
            ['required_conversation_resolution.enabled', want.required_conversation_resolution],
            ['enforce_admins.enabled', want.enforce_admins],
            ['required_linear_history.enabled', want.required_linear_history],
          ];
          let bad = [];
          for (const [k,v] of checks) if (get(live,k)!==v) bad.push(`${k} != ${v}`);
          const wantCtx = want.required_status_checks.contexts.sort().join(',');
          const liveCtx = (live.required_status_checks?.contexts||[]).sort().join(',');
          if (wantCtx !== liveCtx) bad.push(`contexts mismatch: ${liveCtx} != ${wantCtx}`);
          if (bad.length){ 
            console.error('Branch protection drift:\n- '+bad.join('\n- '));
            console.log('Want:', JSON.stringify(want, null, 2));
            console.log('Live:', JSON.stringify({
              strict: get(live, 'required_status_checks.strict'),
              contexts: get(live, 'required_status_checks.contexts'),
              codeowners: get(live, 'required_pull_request_reviews.require_code_owner_reviews'),
              reviews: get(live, 'required_pull_request_reviews.required_approving_review_count'),
              conv: get(live, 'required_conversation_resolution.enabled'),
              admins: get(live, 'enforce_admins.enabled'),
              linear: get(live, 'required_linear_history.enabled')
            }, null, 2));
            process.exit(1);
          }
          JS

  guard-pr-noop:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Neutral pass on PR (required status check)
        run: |
          echo "protection-guard: neutral pass on pull_request event"
          echo "Branch protection check is only performed on push/schedule events"
          exit 0

  guard-pr-noop:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Neutral pass on PR (required status check)
        run: |
          echo "protection-guard: neutral pass on pull_request event"
          echo "Branch protection check is only performed on push/schedule events"
          exit 0
