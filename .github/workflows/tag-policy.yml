name: tag-policy
on:
  push:
    tags: ['v*']  # 릴리즈 태그 푸시에만 동작
permissions: { contents: read }
jobs:
  verify-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Enforce semver + annotated tag
        run: |
          TAG="${GITHUB_REF##*/}"
          echo "Checking tag: $TAG"
          if ! echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Tag must match vMAJOR.MINOR.PATCH"
            exit 1
          fi
          # annotated 여부 확인
          if ! git for-each-ref "refs/tags/$TAG" --format='%(objecttype)' | grep -qx 'tag'; then
            echo "Tag must be annotated (not lightweight)"
            exit 1
          fi
          echo "Tag policy OK"
