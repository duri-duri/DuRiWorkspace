name: Ops Stability Verification

on:
  pull_request:
    paths:
      - 'compose.health.overlay.yml'
      - 'prometheus.yml'
      - 'ops/scripts/**'
      - 'rules.d/**'
  push:
    branches: [main, develop]
    paths:
      - 'compose.health.overlay.yml'
      - 'prometheus.yml'
      - 'ops/scripts/**'
      - 'rules.d/**'

jobs:
  ops-stability:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Install promtool
      run: |
        wget https://github.com/prometheus/prometheus/releases/download/v2.54.1/prometheus-2.54.1.linux-amd64.tar.gz
        tar xzf prometheus-2.54.1.linux-amd64.tar.gz
        sudo mv prometheus-2.54.1.linux-amd64/promtool /usr/local/bin/
        
    - name: Compose merge validation
      run: |
        echo "=== Compose ë³‘í•© ê²€ì¦ ==="
        docker compose -f docker-compose.yml -f compose.health.overlay.yml -p ci config > /tmp/merged.yml
        
        echo "âœ… rules.d ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í™•ì¸"
        grep -q '/etc/prometheus/rules.d' /tmp/merged.yml || { echo "âŒ rules.d ë§ˆìš´íŠ¸ ì—†ìŒ"; exit 1; }
        
        echo "âœ… ë‹¨ì¼ íŒŒì¼ ë°”ì¸ë“œ ì—†ìŒ í™•ì¸"
        ! grep -qE '/etc/prometheus/rules/[^:]+\.yml' /tmp/merged.yml || { echo "âŒ ë‹¨ì¼ íŒŒì¼ ë°”ì¸ë“œ ë°œê²¬"; exit 1; }
        
        echo "âœ… ì´ë¯¸ì§€ ë²„ì „ ê³ ì • í™•ì¸"
        grep -q 'prom/prometheus:v2.54.1' /tmp/merged.yml || { echo "âŒ Prometheus ë²„ì „ ë¯¸ê³ ì •"; exit 1; }
        grep -q 'grafana/grafana:10.4.5' /tmp/merged.yml || { echo "âŒ Grafana ë²„ì „ ë¯¸ê³ ì •"; exit 1; }
        
    - name: Prometheus rules lint
      run: |
        echo "=== Prometheus ë£° ë¦°íŠ¸ ==="
        if [ -d "rules.d" ] && [ "$(ls rules.d/*.yml 2>/dev/null | wc -l)" -gt 0 ]; then
          promtool check rules rules.d/*.yml
          echo "âœ… ë£° ë¦°íŠ¸ í†µê³¼"
        else
          echo "âš ï¸ rules.dì— ë£° íŒŒì¼ ì—†ìŒ (ì •ìƒ)"
        fi
        
    - name: Legacy cleanup verification
      run: |
        echo "=== ê³¼ê±° ìœ ì‚° ì •ë¦¬ í™•ì¸ ==="
        # prometheus_rules.yml ë‹¨ì¼ íŒŒì¼ ë°”ì¸ë“œ ì°¸ì¡°ê°€ ì—†ì–´ì•¼ í•¨
        if grep -R -E 'prometheus_rules\.yml|/etc/prometheus/rules/prometheus_rules\.yml' . --exclude-dir=.git --exclude-dir=data --exclude-dir=dist --exclude-dir=DuRiCore | grep -v COMPLETE_DIFF_PATCH.md | grep -v CODEMAP.md | grep -v PR_TEMPLATE.md; then
          echo "âŒ ê³¼ê±° ìœ ì‚° ë°œê²¬"
          exit 1
        else
          echo "âœ… ê³¼ê±° ìœ ì‚° ì •ë¦¬ ì™„ë£Œ"
        fi
        
    - name: Scripts validation
      run: |
        echo "=== ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ ==="
        chmod +x ops/scripts/*.sh
        
        echo "âœ… smoke_check.sh ì‹¤í–‰ ê°€ëŠ¥"
        bash -n ops/scripts/smoke_check.sh
        
        echo "âœ… verify_diff_patch.sh ì‹¤í–‰ ê°€ëŠ¥"
        bash -n ops/scripts/verify_diff_patch.sh
        
        echo "âœ… quick_verify.sh ì‹¤í–‰ ê°€ëŠ¥"
        bash -n ops/scripts/quick_verify.sh
        
    - name: Runtime verification (if Docker available)
      if: github.event_name == 'push'
      run: |
        echo "=== ëŸ°íƒ€ì„ ê²€ì¦ (ì˜µì…˜) ==="
        # ì‹¤ì œ ëŸ°íƒ€ì„ ê²€ì¦ì€ ë³„ë„ í™˜ê²½ì—ì„œ ìˆ˜í–‰
        echo "ëŸ°íƒ€ì„ ê²€ì¦ì€ ë³„ë„ í™˜ê²½ì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤."
        echo "ë¡œì»¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê²€ì¦í•˜ì„¸ìš”:"
        echo "bash ops/scripts/verify_diff_patch.sh"
        
    - name: Summary
      run: |
        echo "=== ê²€ì¦ ì™„ë£Œ ==="
        echo "âœ… Compose ë³‘í•© ê²€ì¦ í†µê³¼"
        echo "âœ… Prometheus ë£° ë¦°íŠ¸ í†µê³¼"
        echo "âœ… ê³¼ê±° ìœ ì‚° ì •ë¦¬ í™•ì¸"
        echo "âœ… ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ í†µê³¼"
        echo ""
        echo "ğŸš€ ìš´ì˜ ì•ˆì •ì„± ê²€ì¦ ì™„ë£Œ!"
