name: Observability Smoke Tests
on:
  pull_request:
    branches: [main]
    paths:
      - 'ops/observability/**'
      - 'docker-compose.monitoring.yml'
      - 'prometheus.yml'
      - 'Makefile'

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare webhook file
        run: |
          mkdir -p "$RUNNER_TEMP"
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "${{ secrets.SLACK_WEBHOOK_URL }}" > "$RUNNER_TEMP/slack_webhook_url"
          else
            echo 'https://hooks.slack.com/services/PLACE/HOLDER/XXXX' > "$RUNNER_TEMP/slack_webhook_url"
          fi
          chmod 644 "$RUNNER_TEMP/slack_webhook_url"

      - name: Observability checks (harmless)
        run: |
          make SKIP_WEBHOOK_GUARD=1 WEBHOOK_FILE="$RUNNER_TEMP/slack_webhook_url" monitoring-check || echo "::notice::monitoring-check skipped"
          make WEBHOOK_FILE="$RUNNER_TEMP/slack_webhook_url" alertmanager-validate || echo "::notice::alertmanager-validate skipped"
