#!/usr/bin/env bash
set -euo pipefail

# systemd Ïú†Îãõ ÌååÏùº Í≤ÄÏ¶ù
verify_systemd_unit() {
    local unit_file="$1"
    if [ -f "$unit_file" ]; then
        # systemd-analyze verify (user unit)
        if ! systemd-analyze --user verify "$unit_file" 2>/dev/null; then
            echo "‚ùå [FAIL] Invalid systemd unit: $unit_file"
            return 1
        fi
        
        # Ïâò Ï°∞Í∞Å Í≤ÄÏÇ¨ (set -Eeuo, SRC=, DST= Îì±)
        if grep -qE 'set -Eeuo|SRC=|DST=|^if\s+! cmp' "$unit_file"; then
            echo "‚ùå [FAIL] Shell fragments detected in unit file: $unit_file"
            echo "   Remove shell fragments from [Service] section"
            return 1
        fi
    fi
    return 0
}

# coldsync Í¥ÄÎ†® Ïú†Îãõ ÌååÏùº Í≤ÄÏ¶ù
USER_UNIT_DIR="$HOME/.config/systemd/user"
if [ -d "$USER_UNIT_DIR" ]; then
    ERRORS=0
    
    if [ -f "$USER_UNIT_DIR/coldsync-install.service" ]; then
        verify_systemd_unit "$USER_UNIT_DIR/coldsync-install.service" || ERRORS=$((ERRORS + 1))
    fi
    
    if [ -f "$USER_UNIT_DIR/coldsync-install.path" ]; then
        verify_systemd_unit "$USER_UNIT_DIR/coldsync-install.path" || ERRORS=$((ERRORS + 1))
    fi
    
    if [ "$ERRORS" -gt 0 ]; then
        echo ""
        echo "üí° Fix: bash scripts/evolution/fix_service_unit_final.sh"
        exit 1
    fi
fi

exit 0
