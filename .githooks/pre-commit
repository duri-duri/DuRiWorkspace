#!/usr/bin/env bash
set -euo pipefail

# DuRi Secret Hardening Pre-commit Hook
# í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì»¤ë°‹ ë°©ì§€

echo "ğŸ”’ Secret hardening pre-commit check..."

# í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ìŠ¤ìº” (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© ì œì™¸)
if git diff --cached | grep -Ei '(password|secret|token)=' | \
   grep -vE '\.example|CHANGE_ME|POSTGRES_PASSWORD_FILE|secrets/|os\.getenv|os\.environ\.get|getenv\(|environ\.get\('; then
  echo "âŒ Hardcoded secrets detected in staged changes."
  echo "   Please use environment variables or secrets/ directory."
  echo "   Allowed patterns: .example files, CHANGE_ME_*, POSTGRES_PASSWORD_FILE"
  exit 1
fi

# .env íŒŒì¼ ì»¤ë°‹ ë°©ì§€
if git diff --cached --name-only | grep -E '\.env$'; then
  echo "âŒ .env files should not be committed."
  echo "   Please add .env to .gitignore and use .env.example instead."
  exit 1
fi

echo "âœ… Secret hardening check passed"
exit 0
