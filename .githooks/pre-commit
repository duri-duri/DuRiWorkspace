#!/usr/bin/env bash
set -euo pipefail

# DuRi Secret Hardening Pre-commit Hook
# 하드코딩된 시크릿 커밋 방지

echo "🔒 Secret hardening pre-commit check..."

# 하드코딩된 시크릿 스캔 (환경변수 사용 제외)
if git diff --cached | grep -Ei '(password|secret|token)=' | \
   grep -vE '\.example|CHANGE_ME|POSTGRES_PASSWORD_FILE|secrets/|os\.getenv|os\.environ\.get|getenv\(|environ\.get\('; then
  echo "❌ Hardcoded secrets detected in staged changes."
  echo "   Please use environment variables or secrets/ directory."
  echo "   Allowed patterns: .example files, CHANGE_ME_*, POSTGRES_PASSWORD_FILE"
  exit 1
fi

# .env 파일 커밋 방지
if git diff --cached --name-only | grep -E '\.env$'; then
  echo "❌ .env files should not be committed."
  echo "   Please add .env to .gitignore and use .env.example instead."
  exit 1
fi

echo "✅ Secret hardening check passed"
exit 0
