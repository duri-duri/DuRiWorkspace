<!DOCTYPE html>
<html>
<head>
    <title>DuRi 분산 시스템 모니터링</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .node-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .node-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .node-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #4CAF50;
        }
        .status-unhealthy {
            background-color: #f44336;
        }
        .status-warning {
            background-color: #ff9800;
        }
        .metrics {
            margin-top: 15px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .metric-label {
            font-weight: bold;
            color: #666;
        }
        .metric-value {
            color: #333;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .log-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        .automation-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .automation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .control-btn.stop {
            background: #f44336;
        }
        .control-btn:hover {
            opacity: 0.8;
        }
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .log-success {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        .log-error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 DuRi 분산 시스템 모니터링</h1>
            <p>3계층 분산 구조 실시간 모니터링</p>
            <p>마지막 업데이트: <span id="last-update">-</span></p>
        </div>

        <button class="refresh-btn" onclick="refreshData()">🔄 새로고침</button>

        <div class="node-grid">
            <div class="node-card">
                <div class="node-title">🌐 Core Node (포트 8090)</div>
                <div>
                    <span class="status-indicator" id="core-status"></span>
                    <span id="core-status-text">확인 중...</span>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">역할:</span>
                        <span class="metric-value">API Gateway</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">요청 처리:</span>
                        <span class="metric-value" id="core-requests">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">응답 시간:</span>
                        <span class="metric-value" id="core-response-time">-</span>
                    </div>
                </div>
            </div>

            <div class="node-card">
                <div class="node-title">🧠 Brain Node (포트 8091)</div>
                <div>
                    <span class="status-indicator" id="brain-status"></span>
                    <span id="brain-status-text">확인 중...</span>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">역할:</span>
                        <span class="metric-value">판단/기억/철학</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">분석 점수:</span>
                        <span class="metric-value" id="brain-score">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">처리 시간:</span>
                        <span class="metric-value" id="brain-processing-time">-</span>
                    </div>
                </div>
            </div>

            <div class="node-card">
                <div class="node-title">🔄 Evolution Node (포트 8092)</div>
                <div>
                    <span class="status-indicator" id="evolution-status"></span>
                    <span id="evolution-status-text">확인 중...</span>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">역할:</span>
                        <span class="metric-value">학습/평가/개선</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">학습 점수:</span>
                        <span class="metric-value" id="evolution-score">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">개선 제안:</span>
                        <span class="metric-value" id="evolution-suggestions">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>📊 시스템 통계</h3>
            <div class="metrics">
                <div class="metric">
                    <span class="metric-label">전체 상태:</span>
                    <span class="metric-value" id="overall-status">확인 중...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">통합 점수:</span>
                    <span class="metric-value" id="integrated-score">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">처리된 대화:</span>
                    <span class="metric-value" id="total-conversations">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">평균 응답 시간:</span>
                    <span class="metric-value" id="avg-response-time">-</span>
                </div>
            </div>
        </div>

        <div class="automation-section">
            <h3>🤖 자동화 파이프라인</h3>
            <div class="automation-controls">
                <button class="control-btn" onclick="startAutomation()">자동화 시작</button>
                <button class="control-btn stop" onclick="stopAutomation()">자동화 중지</button>
                <button class="control-btn" onclick="triggerAutomation()">수동 트리거</button>
            </div>
            <div class="metrics">
                <div class="metric">
                    <span class="metric-label">자동화 상태:</span>
                    <span class="metric-value" id="automation-status">중지됨</span>
                </div>
                <div class="metric">
                    <span class="metric-label">총 트리거 수:</span>
                    <span class="metric-value" id="total-triggers">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">성공한 학습 사이클:</span>
                    <span class="metric-value" id="successful-cycles">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">평균 학습 점수:</span>
                    <span class="metric-value" id="avg-learning-score">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">마지막 실행:</span>
                    <span class="metric-value" id="last-automation-run">-</span>
                </div>
            </div>
        </div>

        <div class="log-container">
            <h3>📝 시스템 로그</h3>
            <div id="log-entries">
                <div class="log-entry log-info">시스템 모니터링 시작...</div>
            </div>
        </div>
    </div>

    <script>
        let logEntries = [];

        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `<div class="log-entry log-${type}">[${timestamp}] ${message}</div>`;
            logEntries.unshift(entry);

            // 최대 50개 로그 유지
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }

            document.getElementById('log-entries').innerHTML = logEntries.join('');
        }

        function updateNodeStatus(nodeId, isHealthy, statusText) {
            const statusElement = document.getElementById(`${nodeId}-status`);
            const statusTextElement = document.getElementById(`${nodeId}-status-text`);

            if (isHealthy) {
                statusElement.className = 'status-indicator status-healthy';
                statusTextElement.textContent = '정상';
            } else {
                statusElement.className = 'status-indicator status-unhealthy';
                statusTextElement.textContent = '오류';
            }
        }

        async function checkNodeHealth(url, nodeName) {
            try {
                const response = await fetch(`${url}/health`);
                const data = await response.json();
                updateNodeStatus(nodeName.toLowerCase(), true, '정상');
                addLogEntry(`${nodeName} 노드 정상 작동`, 'success');
                return data;
            } catch (error) {
                updateNodeStatus(nodeName.toLowerCase(), false, '오류');
                addLogEntry(`${nodeName} 노드 연결 실패: ${error.message}`, 'error');
                return null;
            }
        }

        async function testSystem() {
            try {
                const response = await fetch('http://localhost:8090/conversation/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: "시스템 모니터링 테스트",
                        duri_response: "분산 시스템이 정상적으로 작동하고 있습니다.",
                        metadata: { source: "dashboard", test: true }
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('integrated-score').textContent = data.integrated_score.toFixed(3);
                    document.getElementById('overall-status').textContent = '정상';
                    addLogEntry(`시스템 테스트 성공: 점수 ${data.integrated_score.toFixed(3)}`, 'success');
                } else {
                    addLogEntry('시스템 테스트 실패', 'error');
                }

                return data;
            } catch (error) {
                addLogEntry(`시스템 테스트 오류: ${error.message}`, 'error');
                return null;
            }
        }

        async function refreshData() {
            addLogEntry('데이터 새로고침 시작...', 'info');

            // 각 노드 상태 확인
            const coreData = await checkNodeHealth('http://localhost:8090', 'Core');
            const brainData = await checkNodeHealth('http://localhost:8091', 'Brain');
            const evolutionData = await checkNodeHealth('http://localhost:8092', 'Evolution');

            // 시스템 테스트
            const systemData = await testSystem();

            // 통계 업데이트
            if (systemData) {
                document.getElementById('total-conversations').textContent = systemData.conversation_id || '-';
                document.getElementById('avg-response-time').textContent = `${(systemData.processing_time * 1000).toFixed(2)}ms`;
            }

            // 마지막 업데이트 시간
            document.getElementById('last-update').textContent = new Date().toLocaleString();

            addLogEntry('데이터 새로고침 완료', 'success');
        }

        // 자동화 파이프라인 함수들
        async function startAutomation() {
            try {
                const response = await fetch('http://localhost:8090/automation/start', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('automation-status').textContent = '실행 중';
                    addLogEntry('자동화 파이프라인 시작됨', 'success');
                } else {
                    addLogEntry('자동화 파이프라인 시작 실패', 'error');
                }
            } catch (error) {
                addLogEntry(`자동화 시작 오류: ${error.message}`, 'error');
            }
        }

        async function stopAutomation() {
            try {
                const response = await fetch('http://localhost:8090/automation/stop', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('automation-status').textContent = '중지됨';
                    addLogEntry('자동화 파이프라인 중지됨', 'info');
                } else {
                    addLogEntry('자동화 파이프라인 중지 실패', 'error');
                }
            } catch (error) {
                addLogEntry(`자동화 중지 오류: ${error.message}`, 'error');
            }
        }

        async function triggerAutomation() {
            try {
                const response = await fetch('http://localhost:8090/automation/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: "수동 트리거 테스트",
                        duri_response: "자동화 파이프라인 테스트 응답",
                        metadata: { source: "dashboard", manual_trigger: true }
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    addLogEntry('수동 트리거 실행됨', 'success');
                } else {
                    addLogEntry('수동 트리거 실패', 'error');
                }
            } catch (error) {
                addLogEntry(`수동 트리거 오류: ${error.message}`, 'error');
            }
        }

        async function updateAutomationStats() {
            try {
                const response = await fetch('http://localhost:8090/automation/stats');
                const data = await response.json();

                if (data.status === 'success') {
                    const stats = data.automation_stats;
                    const learningStats = data.learning_stats;

                    document.getElementById('total-triggers').textContent = stats.total_triggers || 0;
                    document.getElementById('successful-cycles').textContent = stats.successful_learning_cycles || 0;
                    document.getElementById('avg-learning-score').textContent = (stats.average_learning_score || 0).toFixed(3);
                    document.getElementById('last-automation-run').textContent = stats.last_automation_run || '-';
                }
            } catch (error) {
                addLogEntry(`자동화 통계 업데이트 오류: ${error.message}`, 'error');
            }
        }

        // 초기 로드
        refreshData();
        updateAutomationStats();

        // 30초마다 자동 새로고침
        setInterval(refreshData, 30000);
        setInterval(updateAutomationStats, 30000);
    </script>
</body>
</html>
