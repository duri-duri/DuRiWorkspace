# Docker 볼륨을 SSD로 바인드 - 핫 I/O는 SSD, 아카이브/증빙은 HDD
# DURISSD를 폭발 가속에 쓰는 베스트 프랙티스

version: '3.8'

services:
  duri-postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=duri
      - POSTGRES_USER=duri
      - POSTGRES_PASSWORD=duri
    volumes:
      # 🔥 SSD: 핫 데이터베이스
      - /mnt/DURISSD/duri/pgdata:/var/lib/postgresql/data
      # HDD: 백업/아카이브
      - ./backup/postgres:/backup
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U duri -d duri"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  duri-redis:
    image: redis:7-alpine
    volumes:
      # 🔥 SSD: 핫 캐시/큐
      - /mnt/DURISSD/duri/redis:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  duri_brain:
    build:
      context: .
      dockerfile: docker/Dockerfile.brain
    volumes:
      # 🔥 SSD: 모델 캐시
      - /mnt/DURISSD/duri/hf_cache:/root/.cache/huggingface
      # HDD: 모델 아카이브
      - ./models:/models
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -X GET http://localhost:8081/health | grep -q '\"status\":\"ok\"'"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 30s

  aggregation_worker:
    build:
      context: .
      dockerfile: Dockerfile.aggregation
    volumes:
      # 🔥 SSD: 최근 로그
      - /mnt/DURISSD/duri/logs:/app/logs
      # HDD: 로그 아카이브
      - ./logs/archive:/app/logs/archive
    environment:
      - POSTGRES_HOST=duri-postgres
      - POSTGRES_USER=duri
      - POSTGRES_PASSWORD=duri
      - POSTGRES_DB=duri
    depends_on:
      duri-postgres:
        condition: service_healthy
      duri-redis:
        condition: service_healthy

  # 증빙/아카이브 서비스 (HDD)
  archive_worker:
    image: alpine:latest
    volumes:
      # HDD: 증빙 아카이브
      - ./archive:/archive
      - /mnt/DURISSD/duri/logs:/source/logs:ro
    command: >
      sh -c "
        while true; do
          # 1일 지난 로그를 HDD로 이동
          find /source/logs -type f -mtime +1 -exec mv -t /archive/logs {} + 2>/dev/null || true
          # 증빙 번들 생성
          if [ -f /source/logs/agg.log ]; then
            tar -czf /archive/proof_$(date +%Y%m%d-%H%M%S).tar.gz /source/logs/*.log
          fi
          sleep 3600
        done
      "
    restart: unless-stopped

networks:
  default:
    name: duri-network
