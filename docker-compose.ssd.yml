# Docker ë³¼ë¥¨ì„ SSDë¡œ ë°”ì¸ë“œ - í•« I/OëŠ” SSD, ì•„ì¹´ì´ë¸Œ/ì¦ë¹™ì€ HDD
# DURISSDë¥¼ í­ë°œ ê°€ì†ì— ì“°ëŠ” ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

version: '3.8'

services:
  duri-postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=duri
      - POSTGRES_USER=duri
      - POSTGRES_PASSWORD=duri
    volumes:
      # ğŸ”¥ SSD: í•« ë°ì´í„°ë² ì´ìŠ¤
      - /mnt/DURISSD/duri/pgdata:/var/lib/postgresql/data
      # HDD: ë°±ì—…/ì•„ì¹´ì´ë¸Œ
      - ./backup/postgres:/backup
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U duri -d duri"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  duri-redis:
    image: redis:7-alpine
    volumes:
      # ğŸ”¥ SSD: í•« ìºì‹œ/í
      - /mnt/DURISSD/duri/redis:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  duri_brain:
    build:
      context: .
      dockerfile: docker/Dockerfile.brain
    volumes:
      # ğŸ”¥ SSD: ëª¨ë¸ ìºì‹œ
      - /mnt/DURISSD/duri/hf_cache:/root/.cache/huggingface
      # HDD: ëª¨ë¸ ì•„ì¹´ì´ë¸Œ
      - ./models:/models
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -X GET http://localhost:8081/health | grep -q '\"status\":\"ok\"'"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 30s

  aggregation_worker:
    build:
      context: .
      dockerfile: Dockerfile.aggregation
    volumes:
      # ğŸ”¥ SSD: ìµœê·¼ ë¡œê·¸
      - /mnt/DURISSD/duri/logs:/app/logs
      # HDD: ë¡œê·¸ ì•„ì¹´ì´ë¸Œ
      - ./logs/archive:/app/logs/archive
    environment:
      - POSTGRES_HOST=duri-postgres
      - POSTGRES_USER=duri
      - POSTGRES_PASSWORD=duri
      - POSTGRES_DB=duri
    depends_on:
      duri-postgres:
        condition: service_healthy
      duri-redis:
        condition: service_healthy

  # ì¦ë¹™/ì•„ì¹´ì´ë¸Œ ì„œë¹„ìŠ¤ (HDD)
  archive_worker:
    image: alpine:latest
    volumes:
      # HDD: ì¦ë¹™ ì•„ì¹´ì´ë¸Œ
      - ./archive:/archive
      - /mnt/DURISSD/duri/logs:/source/logs:ro
    command: >
      sh -c "
        while true; do
          # 1ì¼ ì§€ë‚œ ë¡œê·¸ë¥¼ HDDë¡œ ì´ë™
          find /source/logs -type f -mtime +1 -exec mv -t /archive/logs {} + 2>/dev/null || true
          # ì¦ë¹™ ë²ˆë“¤ ìƒì„±
          if [ -f /source/logs/agg.log ]; then
            tar -czf /archive/proof_$(date +%Y%m%d-%H%M%S).tar.gz /source/logs/*.log
          fi
          sleep 3600
        done
      "
    restart: unless-stopped

networks:
  default:
    name: duri-network
