# Shadow í›ˆë ¨ì¥ ì™„ì„± ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [íŒŒì¼ êµ¬ì¡°](#íŒŒì¼-êµ¬ì¡°)
3. [í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì‹œìŠ¤í…œ](#í•˜ì´ë¸Œë¦¬ë“œ-ì „ì†¡-ì‹œìŠ¤í…œ)
4. [ì‘ë™ í™•ì¸ ë°©ë²•](#ì‘ë™-í™•ì¸-ë°©ë²•)
5. [ì‚¬ìš© ë°©ë²•](#ì‚¬ìš©-ë°©ë²•)

---

## ì‹œìŠ¤í…œ ê°œìš”

Shadow í›ˆë ¨ì¥ì€ DuRi AI ì‹œìŠ¤í…œì˜ **ì‹¤ì „ í›ˆë ¨ ë° ì§„í™” í…ŒìŠ¤íŠ¸ í™˜ê²½**ì…ë‹ˆë‹¤.

### í•µì‹¬ êµ¬ì„± ìš”ì†Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Shadow í›ˆë ¨ì¥ ì‹œìŠ¤í…œ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Shadow ìŠ¤í¬ë¦½íŠ¸ â”‚â”€â”€â”€â–¶â”‚  ì „ì†¡ ì–´ëŒ‘í„°    â”‚                â”‚
â”‚  â”‚  (ë©”ì¸ ë£¨í”„)     â”‚    â”‚  (HTTP/SSH)     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                         â”‚                          â”‚
â”‚          â”‚                         â–¼                          â”‚
â”‚          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â”‚              â”‚  DuRi AI ì„œë¹„ìŠ¤   â”‚                â”‚
â”‚          â”‚              â”‚  (Core/Brain/    â”‚                â”‚
â”‚          â”‚              â”‚   Evolution/      â”‚                â”‚
â”‚          â”‚              â”‚   Control)        â”‚                â”‚
â”‚          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                         â”‚                          â”‚
â”‚          â–¼                         â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  ë©”íŠ¸ë¦­ ìˆ˜ì§‘      â”‚â—€â”€â”€â”€â”‚  ë©”íŠ¸ë¦­ Exporter  â”‚              â”‚
â”‚  â”‚  (Prometheus)    â”‚    â”‚  (í¬íŠ¸ 9109)      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â”‚                                                  â”‚
â”‚          â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚  EV ë©”íƒ€ ê¸°ë¡    â”‚                                       â”‚
â”‚  â”‚  (ì§„í™” ì¦ê±°)     â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì „ì†¡ ë°©ì‹ (í•˜ì´ë¸Œë¦¬ë“œ)

- **HTTP ëª¨ë“œ** (ê¸°ë³¸): ì•ˆì •ì ì´ê³  ê´€ì¸¡ ê°€ëŠ¥í•œ í†µì‹ 
- **SSH ëª¨ë“œ**: ì‹¤ì „ ë³€ì´ ì‹œë®¬ë ˆì´ì…˜ (ì§€ì—°, ì¥ì• , í‚¤ êµí™˜)
- **MIXED ëª¨ë“œ**: ì¹´ë‚˜ë¦¬ ë°°í¬ (ê¸°ë³¸ 80% HTTP, 20% SSH)

---

## íŒŒì¼ êµ¬ì¡°

### í•µì‹¬ íŒŒì¼

```
DuRiWorkspace/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ shadow_duri_integration_final.sh    # ë©”ì¸ í›ˆë ¨ ìŠ¤í¬ë¦½íŠ¸
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ transport.sh                    # í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì–´ëŒ‘í„°
â”œâ”€â”€ shadow/
â”‚   â”œâ”€â”€ metrics_exporter_enhanced.py         # Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘
â”‚   â””â”€â”€ metrics_exporter.py                 # ê¸°ë³¸ ë©”íŠ¸ë¦­ (ë ˆê±°ì‹œ)
â”œâ”€â”€ scripts/evolution/
â”‚   â”œâ”€â”€ evidence_bundle.sh                  # EV ë©”íƒ€ ê¸°ë¡ (transport í¬í•¨)
â”‚   â””â”€â”€ evidence_score.sh                   # EV ì ìˆ˜ ê³„ì‚°
â””â”€â”€ var/
    â”œâ”€â”€ metrics/
    â”‚   â”œâ”€â”€ transport_metrics.prom          # ì „ì†¡ ë©”íŠ¸ë¦­ (ìë™ ìƒì„±)
    â”‚   â””â”€â”€ ab_eval.prom                    # AB í…ŒìŠ¤íŠ¸ p-value
    â”œâ”€â”€ logs/
    â”‚   â””â”€â”€ shadow.log                      # Shadow í›ˆë ¨ ë¡œê·¸
    â””â”€â”€ evolution/
        â””â”€â”€ EV-YYYYMMDD-HHMMSS-XX/          # ì§„í™” ì¦ê±° ë²ˆë“¤
            â”œâ”€â”€ summary.txt                  # ë©”íƒ€ (transport í¬í•¨)
            â””â”€â”€ ...
```

### íŒŒì¼ ì—­í• 

| íŒŒì¼ | ì—­í•  | ì˜ì¡´ì„± |
|------|------|--------|
| `scripts/shadow_duri_integration_final.sh` | Shadow í›ˆë ¨ ë©”ì¸ ë£¨í”„ | `transport.sh` |
| `scripts/lib/transport.sh` | í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì–´ëŒ‘í„° (HTTP/SSH/MIXED) | ì—†ìŒ |
| `shadow/metrics_exporter_enhanced.py` | Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ë…¸ì¶œ | `transport_metrics.prom` |
| `scripts/evolution/evidence_bundle.sh` | ì§„í™” ì¦ê±° ë²ˆë“¤ ìƒì„± (transport ë©”íƒ€ í¬í•¨) | ì—†ìŒ |

---

## í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì‹œìŠ¤í…œ

### ì „ì†¡ ì–´ëŒ‘í„° (`scripts/lib/transport.sh`)

**ê¸°ëŠ¥:**
- HTTP/SSH/MIXED ëª¨ë“œ ì§€ì›
- ì¹´ë‚˜ë¦¬ ë°°í¬ (í™•ë¥  ê¸°ë°˜ SSH ì„ íƒ)
- ë©”íŠ¸ë¦­ ìë™ ê¸°ë¡
- SSH ì‹¤íŒ¨ ì‹œ HTTP í´ë°±

**í•¨ìˆ˜:**
```bash
# ì„œë¹„ìŠ¤ í˜¸ì¶œ (ìë™ ì„ íƒ)
call_service <service> <path> <method> [data]

# í¸ì˜ í•¨ìˆ˜
call_core <path> <method> [data]      # duri-core ì „ìš©
```

**í™˜ê²½ ë³€ìˆ˜:**
```bash
TRANSPORT=http|ssh|mixed              # ì „ì†¡ ë°©ì‹ (ê¸°ë³¸: http)
SSH_CANARY=0.2                        # SSH ì¹´ë‚˜ë¦¬ í™•ë¥  (ê¸°ë³¸: 20%)
SSH_TIMEOUT=8                         # SSH íƒ€ì„ì•„ì›ƒ (ì´ˆ)
SSH_RETRY=2                           # SSH ì¬ì‹œë„ íšŸìˆ˜

# SSH íƒ€ê²Ÿ (Docker ì»¨í…Œì´ë„ˆ)
CORE_SSH=root@localhost:2220
BRAIN_SSH=root@localhost:2221
EVOLUTION_SSH=root@localhost:2222
CONTROL_SSH=root@localhost:2223
```

### ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (`shadow/metrics_exporter_enhanced.py`)

**ë©”íŠ¸ë¦­:**
- `duri_shadow_transport_total{mode,service,status}`: ì „ì†¡ í˜¸ì¶œ ì¹´ìš´í„°
- `duri_shadow_ssh_failures_total{service}`: SSH ì‹¤íŒ¨ ì¹´ìš´í„°
- `duri_shadow_ssh_latency_ms{service}`: SSH ì§€ì—° ì‹œê°„ (ë¯¸ë˜ êµ¬í˜„)

**ë…¸ì¶œ:**
- HTTP: `http://localhost:9109/metrics`

---

## ì‘ë™ í™•ì¸ ë°©ë²•

### ë¹ ë¥¸ í™•ì¸ (ì›ë¼ì´ë„ˆ)

```bash
# ì „ì²´ ìƒíƒœ í™•ì¸
bash scripts/shadow_check_health.sh

# ìƒì„¸ í™•ì¸
bash scripts/shadow_check_health.sh --verbose
```

### ìˆ˜ë™ í™•ì¸ ì ˆì°¨

#### 1. ì „ì†¡ ì–´ëŒ‘í„° í™•ì¸
```bash
cd /home/duri/DuRiWorkspace

# ì „ì†¡ ì–´ëŒ‘í„° ë¡œë“œ í…ŒìŠ¤íŠ¸
source scripts/lib/transport.sh
call_service "core" "/health" "GET"
# ì˜ˆìƒ ì¶œë ¥: HTTP 200 ì‘ë‹µ ë˜ëŠ” JSON
```

#### 2. DuRi AI ì„œë¹„ìŠ¤ í™•ì¸
```bash
# Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ
docker ps | grep -E "duri-core|duri-brain|duri-evolution|duri-control"

# í—¬ìŠ¤ ì²´í¬ (HTTP)
curl -s http://localhost:8080/health | jq .
curl -s http://localhost:8081/health | jq .
curl -s http://localhost:8082/health | jq .
curl -s http://localhost:8083/health | jq .

# SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (í¬íŠ¸ í™•ì¸)
ssh -p 2220 root@localhost -o ConnectTimeout=2 -o StrictHostKeyChecking=no "echo OK" || echo "SSH ì‹¤íŒ¨"
ssh -p 2221 root@localhost -o ConnectTimeout=2 -o StrictHostKeyChecking=no "echo OK" || echo "SSH ì‹¤íŒ¨"
```

#### 3. ë©”íŠ¸ë¦­ Exporter í™•ì¸
```bash
# Exporter ì‹¤í–‰ í™•ì¸
ps aux | grep metrics_exporter_enhanced.py

# ë©”íŠ¸ë¦­ ë…¸ì¶œ í™•ì¸
curl -s http://localhost:9109/metrics | grep duri_shadow_transport
```

#### 4. Shadow í›ˆë ¨ ì‹¤í–‰ í™•ì¸
```bash
# PID í™•ì¸
cat var/run/shadow.pid 2>/dev/null && echo "Shadow ì‹¤í–‰ ì¤‘" || echo "Shadow ë¯¸ì‹¤í–‰"

# ë¡œê·¸ í™•ì¸
tail -f var/logs/shadow.log

# ìµœê·¼ EV ë²ˆë“¤ í™•ì¸
ls -lt var/evolution/EV-* | head -5
```

---

## ì‚¬ìš© ë°©ë²•

### ê¸°ë³¸ ì‹¤í–‰ (HTTP ëª¨ë“œ)

```bash
cd /home/duri/DuRiWorkspace

# ìŠ¹ì¸ í”Œë˜ê·¸ ìƒì„± (ìµœì´ˆ 1íšŒ)
mkdir -p .shadow
touch .shadow/ALLOW_RUN

# Shadow í›ˆë ¨ ì‹œì‘
TRANSPORT=http bash scripts/shadow_duri_integration_final.sh
```

### SSH ëª¨ë“œ ì‹¤í–‰

```bash
# SSH íƒ€ê²Ÿ ì„¤ì • í™•ì¸
export CORE_SSH=root@localhost:2220
export BRAIN_SSH=root@localhost:2221
export EVOLUTION_SSH=root@localhost:2222
export CONTROL_SSH=root@localhost:2223

# SSH ëª¨ë“œ ì‹¤í–‰
TRANSPORT=ssh bash scripts/shadow_duri_integration_final.sh
```

### í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ ì‹¤í–‰ (ì¹´ë‚˜ë¦¬)

```bash
# ì¹´ë‚˜ë¦¬ í™•ë¥  ì„¤ì • (20% SSH)
export TRANSPORT=mixed
export SSH_CANARY=0.2

# ì‹¤í–‰
bash scripts/shadow_duri_integration_final.sh
```

### Makefile ì‚¬ìš©

```bash
# Shadow ì‹œì‘
make shadow-start

# Shadow ì¤‘ì§€
make shadow-stop

# Shadow ìƒíƒœ í™•ì¸
make shadow-status
```

### ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ (systemd) ì‚¬ìš©

```bash
# ì„œë¹„ìŠ¤ ì‹œì‘
systemctl --user start duri-shadow-exporter.service
systemctl --user start duri-evidence.timer

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
systemctl --user status duri-shadow-exporter.service
systemctl --user list-timers --user duri-*
```

---

## ë¬¸ì œ í•´ê²°

### ë¬¸ì œ: Shadowê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**í™•ì¸ ì‚¬í•­:**
1. ìŠ¹ì¸ í”Œë˜ê·¸ ì¡´ì¬: `ls -la .shadow/ALLOW_RUN`
2. DuRi AI ì„œë¹„ìŠ¤ ì‹¤í–‰: `docker ps | grep duri-`
3. í¬íŠ¸ ì ìœ  í™•ì¸: `ss -tlnp | grep -E '8080|8081|8082|8083'`

**í•´ê²°:**
```bash
# ìŠ¹ì¸ í”Œë˜ê·¸ ìƒì„±
mkdir -p .shadow && touch .shadow/ALLOW_RUN

# DuRi AI ì„œë¹„ìŠ¤ ì‹œì‘
docker compose up -d

# Shadow ì¬ì‹œë„
bash scripts/shadow_duri_integration_final.sh
```

### ë¬¸ì œ: SSH ì—°ê²° ì‹¤íŒ¨

**í™•ì¸ ì‚¬í•­:**
1. Docker ì»¨í…Œì´ë„ˆ SSH í¬íŠ¸ ì—´ë¦¼: `docker ps | grep 222`
2. SSH í‚¤ ì¸ì¦: `ssh -p 2220 root@localhost`
3. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ curl ì‚¬ìš© ê°€ëŠ¥: `docker exec duri-core curl -s http://localhost:8080/health`

**í•´ê²°:**
```bash
# SSH í¬íŠ¸ í™•ì¸
docker ps --format "table {{.Names}}\t{{.Ports}}" | grep duri

# HTTP ëª¨ë“œë¡œ í´ë°±
TRANSPORT=http bash scripts/shadow_duri_integration_final.sh
```

### ë¬¸ì œ: ë©”íŠ¸ë¦­ì´ ìˆ˜ì§‘ë˜ì§€ ì•ŠìŒ

**í™•ì¸ ì‚¬í•­:**
1. Exporter ì‹¤í–‰: `ps aux | grep metrics_exporter`
2. ë©”íŠ¸ë¦­ íŒŒì¼ ìƒì„±: `ls -la var/metrics/transport_metrics.prom`
3. Exporter ë…¸ì¶œ: `curl -s http://localhost:9109/metrics | head -20`

**í•´ê²°:**
```bash
# Exporter ìˆ˜ë™ ì‹œì‘
cd /home/duri/DuRiWorkspace
python3 shadow/metrics_exporter_enhanced.py &

# ë©”íŠ¸ë¦­ íŒŒì¼ í™•ì¸
cat var/metrics/transport_metrics.prom
```

---

## ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

### Prometheus ì¿¼ë¦¬ ì˜ˆì‹œ

```promql
# ì „ì†¡ ëª¨ë“œë³„ í˜¸ì¶œ ìˆ˜
sum(rate(duri_shadow_transport_total[5m])) by (mode)

# SSH ì‹¤íŒ¨ìœ¨
sum(rate(duri_shadow_ssh_failures_total[5m])) / sum(rate(duri_shadow_transport_total{mode="ssh"}[5m]))

# ì„œë¹„ìŠ¤ë³„ ì„±ê³µë¥ 
sum(rate(duri_shadow_transport_total{status="success"}[5m])) by (service) / sum(rate(duri_shadow_transport_total[5m])) by (service)
```

### Grafana ëŒ€ì‹œë³´ë“œ

- ìœ„ì¹˜: `grafana/provisioning/dashboards/shadow_training.json`
- URL: `http://localhost:3000/d/shadow-training`

---

## ì°¸ê³  ìë£Œ

- [í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì‹œìŠ¤í…œ ì„¤ê³„](./docs/hybrid-transport.md) (ë¯¸ë˜ êµ¬í˜„)
- [Shadow í›ˆë ¨ ê³„íš](./SHADOW_TRAINING_PLAN.md)
- [ì§„í™” ì¦ê±° íŒŒì´í”„ë¼ì¸](./scripts/evolution/README.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸:** 2025-10-31
**ë²„ì „:** 1.0.0 (í•˜ì´ë¸Œë¦¬ë“œ ì „ì†¡ ì‹œìŠ¤í…œ í†µí•©)

