# 🛡️ Phase 0: 안전장치 가동 규칙

> **생성일**: 2025-08-22
> **SAFE_BACKUP 태그**: `SAFE_BACKUP_20250822_095423`

## 🔒 **락(Lock) 규칙**

### **1) 실행 락**
- **파일**: `ops/summary/README_patch.lock`
- **규칙**: 락 파일 존재 시 즉시 종료 (ExitCode=100)
- **목적**: 중복 실행 방지, 경합 조건 차단

### **2) 백업 락**
- **파일**: `var/state/backup_in_progress.lock`
- **규칙**: 백업 진행 중 다른 백업 작업 차단
- **해제**: 백업 완료 후 자동 삭제

### **3) 정책 락**
- **파일**: `configs/policy_update.lock`
- **규칙**: 정책 변경 중 백업 실행 차단
- **해제**: 정책 적용 완료 후 수동 삭제

---

## ⏭️ **스킵(Skip) 규칙**

### **1) FULL 백업 스킵**
- **조건**: 동일 날짜에 게이트 FULL 성공
- **결과**: cron 주간 FULL 자동 스킵
- **로직**: `backup_refs.json`에서 날짜별 FULL 상태 확인

### **2) INCR 백업 스킵**
- **조건**: 이전 INCR과 동일한 파일 상태
- **결과**: INCR 실행 스킵, 로그에 "SKIP" 기록
- **로직**: 파일 해시 비교 + 타임스탬프 검증

### **3) RETENTION 스킵**
- **조건**: 보존 정책에 해당하는 파일 없음
- **결과**: RETENTION 실행 스킵, 로그에 "SKIP" 기록
- **로직**: 파일 수명 주기 검사

---

## 🚨 **Fail-Fast 규칙**

### **1) 경로 검증**
- **실패 조건**: 필수 디렉토리/파일 없음
- **동작**: 즉시 종료 + 오류 로그 + 센티넬 파일 생성
- **복구**: 수동 경로 확인 후 재실행

### **2) 권한 검증**
- **실패 조건**: 쓰기 권한 없음
- **동작**: 즉시 종료 + 권한 오류 로그
- **복구**: 권한 수정 후 재실행

### **3) 용량 검증**
- **실패 조건**: 여유 공간 < 소스 용량 × 1.3
- **동작**: 즉시 종료 + 용량 부족 로그
- **복구**: 공간 확보 후 재실행

---

## 🔄 **Graceful Degrade 규칙**

### **1) INCR → FULL 승격**
- **조건**: INCR 실패
- **동작**: 다음날 FULL 백업 자동 스케줄
- **로직**: `GRACE_DEGRADE_FULL_ON_INCR_FAIL=1`

### **2) RETENTION 지연**
- **조건**: RETENTION 실패
- **동작**: 보존 정책 1일 연기 + 경고 표시
- **로직**: `DEFER_RETENTION_ON_FAIL=1`

### **3) USB 미러링 재시도**
- **조건**: USB 미러링 실패
- **동작**: 다음날 INCR 직후 우선 재시도
- **로직**: `.pending_usb_mirror` 파일 기반

---

## 📊 **모니터링 지표**

### **1) 락 상태**
- **락 파일 존재 시간**: 정상 <5분, 경고 5-15분, 오류 >15분
- **락 충돌 횟수**: 일일 <1회, 주간 <3회

### **2) 스킵 비율**
- **FULL 스킵**: 게이트 FULL 성공 시 100% (정상)
- **INCR 스킵**: 변경 없음 시 100% (정상)
- **RETENTION 스킵**: 정리 대상 없음 시 100% (정상)

### **3) Fail-Fast 성공률**
- **경로 검증**: 100% (필수)
- **권한 검증**: 100% (필수)
- **용량 검증**: 100% (필수)

---

## ✅ **Phase 0 완료 체크리스트**

- [ ] **SAFE_BACKUP 태그**: `SAFE_BACKUP_20250822_095423` 생성됨
- [ ] **락 규칙**: 실행/백업/정책 락 정의 완료
- [ ] **스킵 규칙**: FULL/INCR/RETENTION 스킵 로직 정의 완료
- [ ] **Fail-Fast**: 경로/권한/용량 검증 규칙 정의 완료
- [ ] **Graceful Degrade**: INCR→FULL 승격, RETENTION 지연 규칙 정의 완료
- [ ] **모니터링**: 락/스킵/Fail-Fast 지표 정의 완료

---

## 🚀 **다음 단계**

**Phase 1**: SOoT 확정·정책 정렬 + 검증 2중 루프(기초)

> **⚠️ 주의**: Phase 0 완료 후에만 Phase 1 진행 가능
