# alerting/rules/metrics_guard.yml
groups:
- name: rag-metrics-guard
  rules:
  # Recording rule: 이동평균 (플랩 억제)
  - record: duri_ndcg_at_k:avg_1h
    expr: avg_over_time(duri_ndcg_at_k{k="3",scope="all"}[1h])

  - record: duri_ndcg_at_k:avg_6h
    expr: avg_over_time(duri_ndcg_at_k{k="3",scope="all"}[6h])

  # Alert: nDCG 하락 (이동평균 기반, 노이즈 방지)
  - alert: RAG_NDCG_Drop
    expr: (duri_ndcg_at_k:avg_6h - duri_ndcg_at_k:avg_1h) > 0.05
    for: 15m
    labels: { severity: warning }
    annotations:
      summary: "nDCG drop over last 6h (moving average)"
      description: "nDCG@{{ $labels.k }} fell by >0.05. 6h_avg={{ $value }}, 1h_avg={{ $labels.avg_1h }}"

  # Alert: 회귀 탐지 (5분 지속)
  - alert: RAG_Regression_Detected
    expr: duri_guard_last_exit_code{k="3",scope="all",domain="ALL"} == 2
    for: 5m
    labels: { severity: critical }
    annotations:
      summary: "RAG 성능 회귀 감지"
      description: "Guard exit code가 2로 지속됨 (회귀 모드)"
