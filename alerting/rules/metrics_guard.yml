---
# alerting/rules/metrics_guard.yml
groups:
- name: rag-metrics-guard
  rules:
  # Recording rule: 이동평균 (플랩 억제)
  - record: duri_ndcg_at_k:avg_1h
    expr: avg_over_time(duri_ndcg_at_k{k="3",scope="all"}[1h])

  - record: duri_ndcg_at_k:avg_6h
    expr: avg_over_time(duri_ndcg_at_k{k="3",scope="all"}[6h])

  # Alert: nDCG 하락 (이동평균 기반, 노이즈 방지)
  - alert: RAG_NDCG_Drop
    expr: (duri_ndcg_at_k:avg_6h - duri_ndcg_at_k:avg_1h) > 0.05
    for: 15m
    labels: {severity: warning}
    annotations:
      summary: "nDCG drop over last 6h (moving average)"
      description: "nDCG@{{ $labels.k }} fell by >0.05. 6h_avg={{ $value }}, 1h_avg={{ $labels.avg_1h }}"

  # Alert: 회귀 탐지 (5분 지속)
  - alert: RAG_Regression_Detected
    expr: duri_guard_last_exit_code{k="3",scope="all",domain="ALL"} == 2
    for: 5m
    labels: {severity: critical}
    annotations:
      summary: "RAG 성능 회귀 감지"
      description: "Guard exit code가 2로 지속됨 (회귀 모드)"

  # Alert: 텍스트파일 정체 (15분 이상)
  - alert: DuriTextfileStale
    expr: time() - duri_metrics_generated_seconds > 15*60
    for: 10m
    labels: {severity: page}
    annotations:
      summary: "Duri metrics textfile stale (>15m)"
      description: "메트릭 텍스트파일이 15분 이상 갱신되지 않음"

  # Alert: 메트릭 파일 부재
  - alert: DuriTextfileMissing
    expr: absent(duri_exporter_up) or absent(duri_metrics_generated_seconds)
    for: 5m
    labels: {severity: page}
    annotations:
      summary: "Duri metrics textfile missing"
      description: "메트릭 텍스트파일이 존재하지 않음"

  # Alert: 익스포터 다운
  - alert: DuriExporterDown
    expr: duri_exporter_up == 0
    for: 5m
    labels: {severity: page}
    annotations:
      summary: "Duri exporter down"
      description: "DuRi 익스포터가 다운됨"

  # Alert: 알 수 없는 감정 감지 (회귀 방지)
  - alert: UnknownEmotionDetected
    expr: increase(duri_unknown_emotion_total[5m]) > 0
    for: 1m
    labels: {severity: warning}
    annotations:
      summary: "Unknown emotion detected: {{ $labels.emotion_value }}"
      description: "알 수 없는 감정이 감지됨. 정규화 로직 확인 필요."

  # Alert: 감정 정규화 빈도 이상 (회귀 방지)
  - alert: EmotionNormalizationSpike
    expr: rate(duri_emotion_normalized_total[5m]) > 0.1
    for: 2m
    labels: {severity: info}
    annotations:
      summary: "High emotion normalization rate: {{ $labels.from_emotion }} -> {{ $labels.to_emotion }}"
      description: "감정 정규화 빈도가 높음. 클라이언트 입력 패턴 확인 필요."

  # Alert: 자가 리뷰 품질 회귀 감지
  - alert: DuriSelfReviewRegression
    expr: increase(duri_selfreview_regression_total[24h]) > 0
    for: 5m
    labels: {severity: warning}
    annotations:
      summary: "Self-review quality regression detected"
      description: "자가 리뷰 품질 지표가 회귀됨. 코드 품질 게이트 확인 필요."

  # Alert: 뮤테이션 테스트 실패율 증가
  - alert: DuriMutationTestRegression
    expr: (duri_mutation_tests_failed_total / duri_mutation_tests_total_total) > 0.1
    for: 10m
    labels: {severity: warning}
    annotations:
      summary: "Mutation test failure rate >10%"
      description: "뮤테이션 테스트 실패율이 10%를 초과함. 코드 커버리지 확인 필요."

  # Alert: 정적 품질 지표 하락
  - alert: DuriStaticQualityDrop
    expr: duri_maintainability_index < 65
    for: 15m
    labels: {severity: warning}
    annotations:
      summary: "Maintainability index below threshold"
      description: "유지보수성 지수가 임계값(65) 이하로 하락함."

  # Alert: 높은 복잡도 함수 증가
  - alert: DuriHighComplexitySpike
    expr: increase(duri_high_complexity_functions_total[1h]) > 5
    for: 5m
    labels: {severity: info}
    annotations:
      summary: "High complexity functions increased"
      description: "높은 복잡도 함수가 1시간 내 5개 이상 증가함."

  # Alert: 약점 채굴 시스템 활성화
  - alert: DuriWeakpointMiningActive
    expr: increase(duri_error_total[1h]) > 10
    for: 5m
    labels: {severity: info}
    annotations:
      summary: "Weakpoint mining triggered"
      description: "1시간 내 에러가 10개 이상 발생하여 약점 채굴 시스템이 활성화됨."
