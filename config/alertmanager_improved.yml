# Alertmanager ê°œì„ ì•ˆ - ì•ˆì „/ì •í•©/ìœ ì§€ë³´ìˆ˜ í¬ë§·

global:
  resolve_timeout: 5m

templates:
  - '/etc/alertmanager/templates/*.tmpl'

route:
  receiver: 'oncall-slack'        # ë””í´íŠ¸ ë¦¬ì‹œë²„
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 2h

  routes:
    # ë³´ì•ˆ ì´ë²¤íŠ¸ëŠ” ìš°ì„  ë³´ì•ˆ í˜ì´ì €ë¡œ
    - matchers:
        - severity="security"
      receiver: 'security-pager'
      continue: true

    # í¬ë¦¬í‹°ì»¬ì€ í˜ì´ì € + ì˜¨ì½œ ìŠ¬ë™ ë™ì‹œ
    - matchers:
        - severity="critical"
      receiver: 'oncall-pager'
      continue: true

    # ê²½ê³ ëŠ” ì˜¨ì½œ ìŠ¬ë™ìœ¼ë¡œë§Œ
    - matchers:
        - severity="warning"
      receiver: 'oncall-slack'

receivers:
  - name: 'webhook'
    webhook_configs:
      - url_file: /etc/alertmanager/secrets/webhook.url
        send_resolved: true

  - name: 'oncall-pager'
    pagerduty_configs:
      - routing_key_file: /etc/alertmanager/secrets/pagerduty.routing_key   # v2
        severity: '{{ .CommonLabels.severity | default "critical" }}'
        dedup_key: '{{ .GroupLabels.alertname }}:{{ .GroupLabels.cluster }}:{{ .GroupLabels.service }}'
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        details:
          cluster: '{{ .GroupLabels.cluster }}'
          service: '{{ .GroupLabels.service }}'
          runbook_url: '{{ .CommonAnnotations.runbook_url }}'
        send_resolved: true

  - name: 'security-pager'
    pagerduty_configs:
      - routing_key_file: /etc/alertmanager/secrets/security_pd.routing_key
        severity: 'critical'
        dedup_key: 'security:{{ .GroupLabels.alertname }}:{{ .GroupLabels.cluster }}'
        description: 'ğŸ”’ SECURITY: {{ .GroupLabels.alertname }} â€” {{ .CommonAnnotations.summary }}'
        details:
          cluster: '{{ .GroupLabels.cluster }}'
          service: '{{ .GroupLabels.service }}'
          runbook_url: '{{ .CommonAnnotations.runbook_url }}'
        send_resolved: true
    slack_configs:
      - api_url_file: /etc/alertmanager/secrets/slack.webhook
        channel: '#security-alerts'
        title: 'ğŸ”’ SECURITY: {{ .GroupLabels.alertname }}'
        text:  '{{ .CommonAnnotations.description }}'
        color: 'danger'
        send_resolved: true

  - name: 'oncall-slack'
    slack_configs:
      - api_url_file: /etc/alertmanager/secrets/slack.webhook
        channel: '#oncall-alerts'
        title: '{{ if eq .CommonLabels.severity "critical" }}ğŸš¨ CRITICAL{{ else }}âš ï¸ WARNING{{ end }}: {{ .GroupLabels.alertname }}'
        text:  '{{ .CommonAnnotations.description }}'
        color: '{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}'
        send_resolved: true

inhibit_rules:
  # criticalì´ ê°™ì€ alertname/cluster/serviceì—ì„œ ë°œìƒí•˜ë©´ warning ì–µì œ
  - source_matchers: ['severity="critical"']
    target_matchers: ['severity="warning"']
    equal: ['alertname', 'cluster', 'service']
