# DuRi Alertmanager ë¼ìš°íŒ… ê·œì¹™

global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@duri.com'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
  # DuRi ë¬´ê²°ì„± ì•ŒëŒ ë¼ìš°íŒ…
  - match:
      service: duri-integrity
    routes:
    # Critical ì•ŒëŒ - ì¦‰ì‹œ paging
    - match:
        severity: critical
      receiver: oncall-pager
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 5m
      routes:
      # tampered - ìµœê³  ìš°ì„ ìˆœìœ„
      - match:
          alertname: DuRiIntegrityTampered
        receiver: security-pager
        group_wait: 0s
        group_interval: 30s
        repeat_interval: 2m
      # corrupted - ë†’ì€ ìš°ì„ ìˆœìœ„
      - match:
          alertname: DuRiIntegrityFailure
        receiver: oncall-pager
        group_wait: 0s
        group_interval: 1m
        repeat_interval: 5m
      # HMAC ì‹¤íŒ¨ - ë³´ì•ˆ ê´€ë ¨
      - match:
          alertname: DuRiIntegrityHmacFailure
        receiver: security-pager
        group_wait: 0s
        group_interval: 1m
        repeat_interval: 5m
    
    # Warning ì•ŒëŒ - 10ë¶„ ë‚´ 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ paging
    - match:
        severity: warning
      receiver: oncall-slack
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 15m
      routes:
      # policy_changed - ê²½ê³  ìˆ˜ì¤€
      - match:
          alertname: DuRiIntegrityPolicyChanged
        receiver: oncall-slack
        group_wait: 1m
        group_interval: 5m
        repeat_interval: 15m
        # 10ë¶„ ë‚´ 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ paging
        repeat_interval: 10m
        routes:
        - match:
            alertname: DuRiIntegrityPolicyChanged
          receiver: oncall-pager
          group_wait: 0s
          group_interval: 1m
          repeat_interval: 5m
          # 3íšŒ ì—°ì† ì‹¤íŒ¨ ì¡°ê±´
          match_re:
            repeat_count: "3"
      
      # ìŠ¤ìº” ì§€ì—° - ëª¨ë‹ˆí„°ë§
      - match:
          alertname: DuRiIntegrityScanSlow
        receiver: oncall-slack
        group_wait: 2m
        group_interval: 10m
        repeat_interval: 30m
      
      # íŒŒì¼ í­ì¦ - ì£¼ì˜
      - match:
          alertname: DuRiIntegrityFilesSpike
        receiver: oncall-slack
        group_wait: 1m
        group_interval: 5m
        repeat_interval: 15m
      
      # HMAC ë¹„í™œì„±í™” - ì •ë³´
      - match:
          alertname: DuRiIntegrityHmacDisabled
        receiver: oncall-slack
        group_wait: 5m
        group_interval: 15m
        repeat_interval: 1h

receivers:
- name: 'default'
  webhook_configs:
  - url: 'http://localhost:5001/webhook'

- name: 'oncall-pager'
  pagerduty_configs:
  - service_key: 'your-pagerduty-key'
    description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
    details:
      cluster: '{{ .GroupLabels.cluster }}'
      service: '{{ .GroupLabels.service }}'
      runbook_url: '{{ .CommonAnnotations.runbook_url }}'
  
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/your/slack/webhook'
    channel: '#oncall-alerts'
    title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
    text: '{{ .CommonAnnotations.description }}'
    color: 'danger'

- name: 'security-pager'
  pagerduty_configs:
  - service_key: 'your-security-pagerduty-key'
    description: 'ğŸ”’ SECURITY: {{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
    details:
      cluster: '{{ .GroupLabels.cluster }}'
      service: '{{ .GroupLabels.service }}'
      runbook_url: '{{ .CommonAnnotations.runbook_url }}'
      severity: 'security'
  
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/your/slack/webhook'
    channel: '#security-alerts'
    title: 'ğŸ”’ SECURITY: {{ .GroupLabels.alertname }}'
    text: '{{ .CommonAnnotations.description }}'
    color: 'danger'

- name: 'oncall-slack'
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/your/slack/webhook'
    channel: '#oncall-alerts'
    title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
    text: '{{ .CommonAnnotations.description }}'
    color: 'warning'

inhibit_rules:
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'cluster', 'service']
