# 핵심 회고 (문제 → 원인 → 해법)

## 1. MA7 기대값 불일치

**문제:** `exp 0.894285…` vs `got 0.895` 미스매치.

**원인:** promtool의 샘플 시점/윈도우 경계(평균에 포함되는 포인트 개수)가 테스트 `interval`·`eval_time` 조합과 딱 안 맞았어요.

**해법:** `eval_time`을 창 크기 끝에 정렬하고 기대값을 재계산. 최종적으로 **MA7 계산만 검증**하는 테스트로 분리해 안정화 ✅

## 2. for: 15m 알람 테스트가 발화 안 됨

**문제:** `MRR_SLO_Breach`(for: 15m) 기대 알람이 `got: []`.

**원인:** 임계 하회 구간이 "연속 15m"로 충분히 유지되지 못하거나, MA7이 실제로 SLO 미만으로 내려오지 않은 타이밍에 `eval_time`을 찍음.

**해법(일반 패턴):**
- **충분한 워밍업**(정상값) → **충분한 위반 구간**(for 시간보다 길게) → `eval_time`은 위반 시작 시점 + for + ε.
- 예: `interval: 1m`, `values: '0.90x30 0.86x20'`, `eval_time: 46m` (위반 16분 경과) 처럼 "for 충족 + 1분" 지점에서 확인.

## 3. runbook_url 주입 후 YAML 오류

**문제:** `did not find expected key`(들여쓰기/inline map).

**원인:** `labels: {…}` 한 줄 맵에 `runbook_url`을 별도 줄로 추가하면서 들여쓰기가 깨짐.

**해법:** `labels:`를 블록 맵으로 변환해 정식 들여쓰기 유지. 이후 전 파일 재정렬로 해결 ✅

## 4. 라벨 가드 스크립트

**문제:** awk 버전/예약어(`in`) 차이 + 라벨 범위 오검출.

**해법:** **Python판으로 교체 + `labels:` 블록 한정 + 재귀 스캔**. 파일 끝 마지막 알람까지 평가하도록 flush 로직 추가 ✅

## 5. pre-commit 구성 충돌

**문제:** hook 리포 섞임/중복 문서/없는 훅 선언.

**해법:** `pre-commit-hooks`와 `black/isort/flake8`를 **각 리포 원본으로 분리 선언**. yamllint는 로컬 규칙(.yamllint)로 경고 완화 또는 제거. 최종 전부 PASS ✅

---

# 앞으로의 재발 방지 팁 (짧고 굵게)

## 알람 테스트는 계산과 알람을 분리

1. 녹화(레코딩/집계) 식의 **수치 검증** 테스트
2. 그 결과를 사용한 **알람(for 포함) 검증** 테스트
   → 지금처럼 분리하면 원인 추적이 훨씬 쉬워져요.

## for 테스트의 정석 매크로

```yaml
# 분 단위 예시
# 정상(0.90) 30분 → 위반(0.86) 16분 → eval_time 46m (위반 시작 + 16m)
interval: 1m
values: '0.90x30 0.86x20'
alert_rule_test:
  - eval_time: 46m  # 15m 충족 + 1m
    alertname: YOUR_ALERT
    exp_alerts: [ ... ]
```

## 라벨 가드 정확도 유지

지금처럼 **labels 블록 내부만** 검사하면 annotations/description에 있는 단어와 충돌하지 않습니다.

## 워크플로 길이/진실값 경고

길 수밖에 없는 GitHub Actions YML은 `.yamllint`에서만 완화하거나(지금처럼) 아예 ignore 해두면 잡음이 사라집니다.

---

## 현재 상태

- ✅ 모든 검증 PASS
- ✅ 운영/재현성/가독성 삼박자 완성
- ✅ Phase 3 진입 준비 100% 완료
- 🧊 조용히 잘 도는 레포 모드
