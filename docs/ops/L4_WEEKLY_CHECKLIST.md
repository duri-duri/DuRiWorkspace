# L4 관찰 기간 일주일 체크리스트
# Purpose: 일주일 동안 매일 체크해야 할 항목과 실행 가이드

## 📅 일주일 일정표

### 매일 (월~일, 10분)

#### 1. 일일 관찰 스크립트 실행
```bash
cd /home/duri/DuRiWorkspace
bash scripts/ops/l4_daily_observation.sh
```

**확인 사항:**
- ✅ Checklist: PASS
- ✅ Evaluation snapshot 생성됨
- ✅ Audit index 업데이트됨
- ✅ Rollback events: 0 또는 기록됨

**저장 위치:** `var/audit/daily_summary_YYYYMMDD.txt`

#### 2. 수동 체크 (5분)

**A. 롤백 이벤트 확인 (있다면)**
```bash
# 롤백 이벤트가 발생했는지 확인
cat docs/ops/audit/audit_index.jsonl | jq -r 'select(.stage=="rollback") | "\(.ts)|\(.result)|\(.reason)"'
```

**롤백이 발생했다면:**
1. PR 번호 확인
2. 롤백 이유 확인 (SLO 위반인지)
3. **수동 라벨링** (TP/FP 판정)
   ```bash
   # var/audit/rollback_label.tsv 파일 생성/업데이트
   echo "$(date +%Y%m%d)	<PR_NUMBER>	TP/FP	<NOTES>" >> var/audit/rollback_label.tsv
   ```

**B. 정책 학습 PR 확인**
```bash
# 정책 학습 루프가 PR을 생성했는지 확인
gh pr list --search "label:policy:update-proposed" --json number,title,createdAt
```

**PR이 있다면:**
- ✅ 열람만 (merge/close 금지)
- ✅ 제안 내용 검토
- ✅ 7일 후 주간 요약에서 반영 여부 확인

**C. SLO 메트릭 확인 (Prometheus 설정된 경우)**
```bash
# 일일 관찰 스크립트에서 생성된 SLO 메트릭 확인
ls -lth var/audit/slo_*.json | head -1
cat var/audit/slo_$(date +%Y%m%d)*.json | jq '.data.result[]' 2>/dev/null || echo "메트릭 없음"
```

**확인 사항:**
- 메트릭이 정상적으로 쿼리되었는지
- 임계값 초과 여부 (직접 비교, 수정 금지)

---

### 주간 (7일차, 30분)

#### 1. 주간 요약 계산
```bash
cd /home/duri/DuRiWorkspace
bash scripts/ops/l4_weekly_summary.sh
```

**출력 확인:**
- **R_SLO** (SLO 통과율): 목표 ≥ 99.0%
- **FP_RB** (오탐 롤백율): 목표 ≤ 1.0%
- **MTTD p95** (평균 탐지 시간): 목표 ≤ 180초 (3분)
- **MTTR p95** (평균 복구 시간): 목표 ≤ 600초 (10분)
- **U_POLICY** (정책 효과성): 목표 = 1.0
- **Promotion Score**: 목표 ≥ 0.92

**판정:**
- Score ≥ 0.92: ✅ **Global L4 운영 승인**
- Score ≥ 0.85: ⚠️ 관찰 계속, 점진적 확장
- Score < 0.85: ❌ 임계값 재검토 필요

#### 2. 주간 리포트 검토
```bash
# 주간 요약 리포트 확인
cat var/audit/weekly_summary_$(date +%Y%m%d).json | jq .
```

**확인 사항:**
- 각 메트릭이 목표치를 달성했는지
- 롤백 이벤트 패턴 분석
- 정책 학습 효과성 평가

---

## 📋 일일 체크리스트 (체크박스)

### 월요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 (없으면 스킵)
- [ ] 정책 학습 PR 확인 (없으면 스킵)
- [ ] SLO 메트릭 확인 (설정된 경우)
- [ ] 체크리스트 결과 기록

### 화요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 및 라벨링 (있는 경우)
- [ ] 정책 학습 PR 확인
- [ ] 전일 대비 변화 확인

### 수요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 및 라벨링 (있는 경우)
- [ ] 정책 학습 PR 확인
- [ ] 중간 패턴 분석 (3일치 데이터)

### 목요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 및 라벨링 (있는 경우)
- [ ] 정책 학습 PR 확인
- [ ] SLO 메트릭 트렌드 확인

### 금요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 및 라벨링 (있는 경우)
- [ ] 정책 학습 PR 확인
- [ ] 주간 중간 점검 (5일치 데이터)

### 토요일
- [ ] 일일 관찰 스크립트 실행
- [ ] 롤백 이벤트 확인 및 라벨링 (있는 경우)
- [ ] 정책 학습 PR 확인
- [ ] 백업 상태 확인 (옵션)

### 일요일 (7일차 - 주간 요약)
- [ ] 일일 관찰 스크립트 실행
- [ ] **주간 요약 계산 실행**
- [ ] **승격 점수 확인**
- [ ] **판정 문서화**
- [ ] 다음 단계 결정

---

## 🎯 핵심 원칙 (반드시 지킬 것)

### ✅ 해야 할 것

1. **매일 10분 관찰 루틴 실행**
   - `bash scripts/ops/l4_daily_observation.sh`
   - 결과를 기록하지 말고 자동 저장됨

2. **롤백 이벤트 라벨링 (발생 시)**
   - TP (True Positive): 실제 SLO 위반으로 롤백이 필요한 경우
   - FP (False Positive): 오탐으로 불필요한 롤백인 경우

3. **정책 학습 PR 검토 (생성 시)**
   - 열람만, merge/close 금지
   - 제안 내용 이해

4. **7일차 주간 요약 및 판정**
   - 승격 점수 계산
   - Global L4 승인 여부 결정

### ❌ 하지 말아야 할 것

1. **임계값 수정 금지**
   - `.slo/auto_relax.yml` 수정 안 함
   - 워크플로우 설정 변경 안 함

2. **롤백 수동 트리거 금지**
   - 자동 롤백만 허용
   - 수동 롤백은 테스트 목적 제외

3. **정책 학습 PR merge 금지**
   - 관찰 기간 중에는 merge 안 함
   - 7일 후 주간 요약 반영 후 결정

4. **프로덕션 변경 금지**
   - 코드 변경 최소화
   - 긴급 상황 제외

---

## 📊 주요 지표 및 목표

### SLO 통과율 (R_SLO)
- **목표:** ≥ 99.0%
- **측정:** 머지 후 120분 윈도우 통과 비율
- **확인:** `audit_index.jsonl`에서 `stage=="post-merge-watch"` 결과 집계

### 오탐 롤백율 (FP_RB)
- **목표:** ≤ 1.0%
- **측정:** 롤백 중 실제로 불필요했던 비율
- **확인:** `rollback_label.tsv`에서 FP 비율 계산

### 평균 탐지 시간 (MTTD p95)
- **목표:** ≤ 3분 (180초)
- **측정:** 머지부터 SLO 위반 탐지까지 시간의 p95
- **확인:** `audit_index.jsonl`에서 타임스탬프 차이 계산

### 평균 복구 시간 (MTTR p95)
- **목표:** ≤ 10분 (600초)
- **측정:** 롤백 트리거부터 복구 완료까지 시간의 p95
- **확인:** `audit_index.jsonl`에서 타임스탬프 차이 계산

### 정책 효과성 (U_POLICY)
- **목표:** 1.0 (중복/무의미 제안 0건)
- **측정:** 정책 학습 PR의 중복/무의미 제안 여부
- **확인:** 정책 학습 PR 목록 검토

---

## 🚨 이상 징후 감지 시

### 롤백이 너무 많다면 (일일 3건 이상)
- SLO 임계값이 너무 엄격한지 확인
- 롤백 이유 분석 (어떤 메트릭이 위반되는지)
- **하지만 임계값 수정은 7일 후**

### 롤백이 전혀 없다면
- 정상적인 상황이거나
- SLO 메트릭이 수집되지 않는 경우
- Prometheus 연결 확인

### 정책 학습 PR이 너무 많다면 (주간 3건 이상)
- 실패 패턴이 반복되는지 확인
- 정책 학습 루프의 rate limiting 확인

### 승격 점수가 0.85 미만이라면
- 어떤 메트릭이 목표를 달성하지 못했는지 확인
- 롤백 이벤트 패턴 분석
- 다음 주간에 임계값 조정 검토

---

## 📝 일일 기록 템플릿

매일 관찰 후 간단히 기록:

```
## YYYY-MM-DD

### 일일 관찰
- [ ] 스크립트 실행: ✅/❌
- [ ] 체크리스트: PASS/FAIL
- [ ] 롤백 이벤트: 0건 / N건 (TP: X, FP: Y)
- [ ] 정책 학습 PR: 0건 / N건
- [ ] SLO 메트릭: 정상/이상/없음

### 특이 사항
- (있으면 기록)

### 다음 날 확인 사항
- (있으면 기록)
```

---

## 🎯 7일차 최종 판정 기준

### 승격 점수 ≥ 0.92
✅ **Global L4 운영 승인**
- 시스템이 안정적으로 작동함
- 자동 롤백이 효과적임
- 정책 학습이 작동함
- **다음 단계:** 다중 시나리오 확장

### 승격 점수 0.85-0.91
⚠️ **관찰 계속, 점진적 확장**
- 대부분의 메트릭은 목표 달성
- 일부 개선 여지 있음
- **다음 단계:** 임계값 미세 조정 후 재관찰

### 승격 점수 < 0.85
❌ **임계값 재검토 필요**
- 주요 메트릭이 목표 미달성
- 롤백 패턴 분석 필요
- **다음 단계:** 임계값 조정 및 재설계

---

## 💡 팁

1. **매일 같은 시간에 실행** (예: 오후 4시)
   - 일관된 관찰 가능
   - 패턴 분석 용이

2. **롤백 이벤트 즉시 기록**
   - 시간이 지나면 판단이 어려워짐
   - TP/FP 라벨링 신중히

3. **7일차 주간 요약은 충분한 시간 확보**
   - 30분 이상 투자
   - 판정 근거 명확히 문서화

4. **문제 발생 시 조치**
   - 긴급 상황이 아니면 7일 후까지 대기
   - 데이터 축적 후 결정

---

## 📞 지원

- 문서: `docs/ops/L4_OBSERVATION_GUIDE.md`
- 스크립트: `scripts/ops/l4_daily_observation.sh`
- 주간 요약: `scripts/ops/l4_weekly_summary.sh`
- 정적 검증: `scripts/ops/l4_static_validation.sh`

