# L4 Promotion Roadmap

## 현재 상태 평가

### 단일 시나리오 L4 준수도
- **현재 판정**: L3.9 (L4 근접, 단일 시나리오)
- **L4 인증 가능성**: p≈0.75-0.85
- **전역 L4 판단 확률**: p≈0.3-0.4

### L4 최소충분조건 충족도

| 조건 | 상태 | 비고 |
|------|------|------|
| 1. 정합성 게이트 | ✅ | 6중 게이트, 경로 allowlist, fork 차단, actor whitelist |
| 2. 실행 원자성 | ✅ | 3중 복원 (trap + always() + final safety net) |
| 3. 사후 검증 | ✅ | 머지 검증, 보호설정 검증 |
| 4. 감사/재현 | ✅ | Artifact, 감사 디렉토리, 코멘트 |
| 5. 러닝 루프 | ⚠️ | 실패 분류 및 정책 업데이트 미구현 |
| 6. 범용성 | ⚠️ | 다중 시나리오 일반화 미구현 |
| 7. 사후 품질 감시 | ⚠️ | SLO 감시 및 자동 롤백 미구현 |

## 다음 단계: 전역 L4 승급을 위한 5개 델타

### 우선순위 1: 사후 품질 SLO 감시 + 자동 롤백

**목표**: 머지 후 30-120분 윈도우에서 실제 서비스 SLO 감시 및 임계 초과 시 자동 롤백

**구현 계획**:
1. `l4-post-merge-quality-watch.yml` 워크플로우 구현 ✅ (초기 버전 완료)
2. Prometheus SLO 메트릭 쿼리 연동
3. 자동 롤백 워크플로우 (`l4-auto-rollback.yml`) 구현
4. 롤백 후 보호설정 복원 확인

**검증 기준**:
- SLO 위반 감지 정확도 ≥ 95%
- 롤백 실행 시간 ≤ 5분
- 롤백 후 시스템 안정성 확인

### 우선순위 2: 정책 러닝 루프

**목표**: 실패 원인 분류 및 allowlist/denylist 규칙 자동 업데이트 PR 제안

**구현 계획**:
1. 실패 원인 분류 시스템 (라벨 기반)
2. 정책 업데이트 템플릿 생성
3. 자동 PR 생성 워크플로우
4. 인간 승인 프로세스

**검증 기준**:
- 실패 원인 분류 정확도 ≥ 90%
- 정책 업데이트 제안 적절성 ≥ 85%
- 수동 승인률 ≤ 20% (대부분 자동 승인)

### 우선순위 3: 다중 시나리오 일반화

**목표**: 현재 allowlist 외에 테라폼/헬름/관측/릴리즈 등 클래스로 규칙 템플릿화

**구현 계획**:
1. `rulepack/*.yml` 구조 설계
2. 공통 엔진으로 규칙 템플릿 적용
3. 시나리오별 allowlist 확장

**검증 기준**:
- 템플릿 적용 성공률 ≥ 95%
- 규칙 전이 정확도 ≥ 90%

### 우선순위 4: 카나리/드라이런 게이트

**목표**: relax→merge 전에 드라이런(sandbox ruleset) 적용 성공 확인

**구현 계획**:
1. 가상 복원 시뮬레이터 구현
2. sandbox ruleset 적용 테스트
3. 게이트 통과 후 실제 merge 진행

**검증 기준**:
- 드라이런 성공률 ≥ 98%
- 실제 merge 성공률 향상 ≥ 5%

### 우선순위 5: 회귀 요약 리포트

**목표**: 머지+N시간 후 SLO/알림/롤백 여부/원인 요약을 자동 코멘트/주간 리포트로 축적

**구현 계획**:
1. 회귀 데이터 수집 시스템
2. 리포트 템플릿 생성
3. 자동 코멘트 및 주간 리포트 생성

**검증 기준**:
- 리포트 정확도 ≥ 90%
- 다음 게이트 가중치 반영 효과 ≥ 10% 개선

## 승격 판정 수식

```
promotion_score = 0.5·pass_rate + 0.2·(1 - mttr_norm) + 0.2·recovery_ok + 0.1·audit_completeness
```

- `pass_rate` = 성공/총시도
- `mttr_norm` = min(MTTR/60s, 1)
- `recovery_ok` = 완전복원율(0~1)
- `audit_completeness` = 필수 로그/아티팩트 존재율(0~1)

**기준**: `promotion_score ≥ 0.95` → **L4 승인**

## 빠른 자가테스트 절차

1. **합성 PR 생성**: allowlist 변경만, checks green
2. **라벨 부착**: `change:safe` + `auto-relax-merge`
3. **자동 실행 관찰**: 워크플로우 실행 확인
4. **보호설정 복원 확인**: CLI로 검증
5. **Artifact 확인**: 스냅샷 다운로드 및 diff
6. **런너 실패 시뮬레이션**: final safety net 확인
7. **Idempotency 확인**: 머지된 PR에 `/auto-merge` 코멘트

모두 통과 시 **이 시나리오에 한해 L4 인증 가능**

## 예상 일정

| 단계 | 예상 기간 | 목표 확률 |
|------|-----------|-----------|
| 우선순위 1 (SLO 감시) | 2-3주 | p→0.85 |
| 우선순위 2 (러닝 루프) | 3-4주 | p→0.90 |
| 우선순위 3 (일반화) | 2-3주 | p→0.92 |
| 우선순위 4 (드라이런) | 1-2주 | p→0.94 |
| 우선순위 5 (리포트) | 1-2주 | p→0.95+ |

**총 예상 기간**: 9-14주

## 참고 자료

- [Auto Relax Merge Restore Runbook](./AUTO_RELAX_MERGE_RUNBOOK.md)
- [L4 Evaluation Script](../scripts/ops/l4_evaluation.sh)
- [L4 Self-Test Script](../scripts/ops/l4_self_test.sh)

