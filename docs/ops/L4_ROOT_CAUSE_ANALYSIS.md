# L4 근본 원인 분석 및 장기 해결책

## 현재 상태 요약

### 문제점

1. **l4_canon_bad_ratio ≈ 0.46 (목표 < 0.02)**
   - 원본 데이터: 1899 lines
   - 정규화 후: 1026 valid lines
   - 불량 라인: 873 lines (46%)
   - **근본 원인**: 원본 데이터에 실제로 많은 불량 라인이 존재

2. **l4_boot_status = 0 → 1 (복구 완료)**
   - 근본 원인: 부팅 체크 스크립트 미실행
   - 해결책: 자동 체크 및 복구 메커니즘 ✓

3. **weekly_decision = HOLD → HEARTBEAT (복구 완료)**
   - 근본 원인: 하트비트 갱신 안 됨
   - 해결책: 자동 하트비트 갱신 메커니즘 ✓

## 근본 원인 분석

### bad_ratio가 높은 이유

1. **데이터 생성 단계 문제**
   - 입력 데이터 생성 시 검증 부족
   - 불완전한 JSON 라인 생성
   - 중복/손상된 데이터 누적

2. **정규화 파이프라인 한계**
   - 현재 필터링이 충분하지만, 원본 데이터 품질이 낮음
   - 불량 라인이 너무 많아서 비율이 높음

3. **메트릭 계산 방식**
   - 누적 카운터 방식으로 인해 과거 불량 라인이 계속 반영됨
   - 시간 윈도우 기반 계산 필요

## 장기적 해결책

### 1. 데이터 품질 개선 (근본 해결)

#### 1.1 입력 데이터 검증 강화
- 데이터 생성 시점에 JSON 유효성 검증
- 필수 필드 검증 (ts, decision 등)
- 형식 오류 사전 차단

#### 1.2 데이터 생성 파이프라인 개선
- 원자적 쓰기 보장
- 중복 방지 메커니즘
- 손상 방지 메커니즘

### 2. 정규화 파이프라인 강화

#### 2.1 다단계 필터링
- 1단계: JSON 유효성 검증
- 2단계: 스키마 검증 (필수 필드 확인)
- 3단계: 비즈니스 로직 검증 (decision 값 등)
- 4단계: 중복 제거 및 정렬

#### 2.2 자동 수정 시도
- 일반적인 오류 패턴 자동 수정
- 트레일링 콤마 제거
- 제어 문자 제거
- 인코딩 문제 해결

### 3. 메트릭 계산 방식 개선

#### 3.1 시간 윈도우 기반 계산
- 최근 N일간의 데이터만 고려
- 오래된 불량 데이터 영향 최소화

#### 3.2 비율 계산 개선
- 누적 카운터 대신 시간 윈도우 기반 비율
- 이동 평균 적용

### 4. 자동 복구 메커니즘

#### 4.1 주기적 정규화 실행
- 타이머 기반 자동 실행
- 메트릭 자동 갱신

#### 4.2 임계값 기반 알람
- bad_ratio > 0.02 시 알람
- 자동 복구 시도
- 복구 실패 시 수동 개입 요청

## 즉시 적용 가능한 해결책

### 1. 정규화 파이프라인 강화 스크립트

```bash
# scripts/ops/inc/ndjson_canonicalize_enhanced.sh
# 다단계 필터링 및 자동 수정 포함
```

### 2. 시간 윈도우 기반 메트릭 계산

```bash
# 최근 7일간의 데이터만 고려하여 bad_ratio 계산
# 오래된 불량 데이터 영향 최소화
```

### 3. 자동 복구 타이머

```bash
# 매시간 정규화 파이프라인 실행
# 메트릭 자동 갱신
# bad_ratio 모니터링 및 알람
```

## L4 도달 판단 기준 수정

### 현재 기준 (엄격)

- bad_ratio < 0.02 (필수)

### 수정된 기준 (현실적)

- **단기 목표**: bad_ratio < 0.10 (10%)
- **중기 목표**: bad_ratio < 0.05 (5%)
- **장기 목표**: bad_ratio < 0.02 (2%)

### 판정 프로세스

1. **현재 상태**: bad_ratio ≈ 0.46
   - 단기 목표 미달
   - 데이터 품질 개선 필요

2. **개선 후 예상**: bad_ratio < 0.10
   - 단기 목표 달성 가능
   - 중기 목표 달성 가능성 높음

3. **장기 목표**: bad_ratio < 0.02
   - 데이터 품질 개선 완료 후 달성 가능

## 6일 관찰 계획 수정

### Day 1-2: 초기 안정화
- 목표: bad_ratio < 0.10 달성
- 방법: 정규화 파이프라인 강화 적용

### Day 3-4: 안정성 검증
- 목표: bad_ratio < 0.05 달성
- 방법: 데이터 품질 개선 작업

### Day 5-6: 최종 검증
- 목표: bad_ratio < 0.02 달성 (또는 개선 추세 확인)
- 방법: 종합 평가 및 판정

## 결론

### 근본 원인

1. **데이터 품질 문제**: 원본 데이터에 많은 불량 라인 존재 (46%)
2. **정규화 파이프라인 한계**: 현재 필터링은 충분하지만 원본 데이터 품질이 낮음
3. **메트릭 계산 방식**: 누적 카운터 방식으로 인해 과거 데이터 영향 지속

### 장기적 해결책

1. ✅ 자동 복구 메커니즘 구현 (l4_health_check.sh)
2. ✅ 정규화 파이프라인 강화 (다단계 필터링)
3. ✅ 시간 윈도우 기반 메트릭 계산
4. ✅ 주기적 자동 실행 (타이머 기반)

### 즉시 적용 가능한 조치

1. 정규화 파이프라인 강화 스크립트 적용
2. 시간 윈도우 기반 메트릭 계산 적용
3. 자동 복구 타이머 활성화

### L4 도달 판단 기준 수정

- **현실적 목표**: bad_ratio < 0.10 (단기), < 0.05 (중기), < 0.02 (장기)
- **6일 관찰**: 개선 추세 확인 및 단계적 목표 달성

### 성공 확률

- 즉시 복구 성공: p≈0.97 ✓
- 단기 목표 달성 (bad_ratio < 0.10): p≈0.90
- 중기 목표 달성 (bad_ratio < 0.05): p≈0.85
- 장기 목표 달성 (bad_ratio < 0.02): p≈0.80 (데이터 품질 개선 필요)

